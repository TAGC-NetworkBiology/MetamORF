<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>sORFdatafreezer: fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">sORFdatafreezer
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><b>fr</b></li><li class="navelem"><b>tagc</b></li><li class="navelem"><b>uorf</b></li><li class="navelem"><b>core</b></li><li class="navelem"><b>execution</b></li><li class="navelem"><b>MergeStrategy</b></li><li class="navelem"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html">MergeStrategy</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="#pub-static-attribs">Static Public Attributes</a> &#124;
<a href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Inheritance diagram for fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.png" usemap="#fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy_map" alt=""/>
  <map id="fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy_map" name="fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy_map">
<area href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1ResumeMergeStrategy_1_1ResumeMergeStrategy.html" alt="fr.tagc.uorf.core.execution.ResumeMergeStrategy.ResumeMergeStrategy" shape="rect" coords="0,56,428,80"/>
  </map>
</div></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a13ba6c2d12de752a21b7ec2717553b0d"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a13ba6c2d12de752a21b7ec2717553b0d">__init__</a> (self)</td></tr>
<tr class="separator:a13ba6c2d12de752a21b7ec2717553b0d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a999869c415f278d64898cfc966900530"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a999869c415f278d64898cfc966900530">parse_config</a> (self)</td></tr>
<tr class="separator:a999869c415f278d64898cfc966900530"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1cea36b0b441a121fd33ff5fc0194242"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a1cea36b0b441a121fd33ff5fc0194242">execute</a> (self)</td></tr>
<tr class="separator:a1cea36b0b441a121fd33ff5fc0194242"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8aa4cf77691658b414a5a109a3cef0a2"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a8aa4cf77691658b414a5a109a3cef0a2">copy_conserved_tables</a> (self)</td></tr>
<tr class="separator:a8aa4cf77691658b414a5a109a3cef0a2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a853e3c9d47078794ecb829fb5185e638"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a853e3c9d47078794ecb829fb5185e638">merge_dsorfs</a> (self)</td></tr>
<tr class="separator:a853e3c9d47078794ecb829fb5185e638"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6bd4005b55af502f76009505ae736193"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a6bd4005b55af502f76009505ae736193">merge_dstranscripts</a> (self)</td></tr>
<tr class="separator:a6bd4005b55af502f76009505ae736193"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a69763877faecc4732eed2ab09cf32453"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a69763877faecc4732eed2ab09cf32453">merge_dsorftranscriptasso</a> (self)</td></tr>
<tr class="separator:a69763877faecc4732eed2ab09cf32453"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8b12d5286400a811fc83c1f86c25e74d"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a8b12d5286400a811fc83c1f86c25e74d">get_dsorftranscriptasso_to_merge</a> (self)</td></tr>
<tr class="separator:a8b12d5286400a811fc83c1f86c25e74d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afdc08ae739263aa042c205f70e3bc040"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#afdc08ae739263aa042c205f70e3bc040">merge_dsota</a> (self)</td></tr>
<tr class="separator:afdc08ae739263aa042c205f70e3bc040"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9f9c6169557031f5ff1c270f3761d060"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a9f9c6169557031f5ff1c270f3761d060">clean_pro_database</a> (self)</td></tr>
<tr class="separator:a9f9c6169557031f5ff1c270f3761d060"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a06419bdc055688700361394430138509"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a06419bdc055688700361394430138509">batch_insert_to_PRO_db</a> (self, objects_to_insert, filename, process='Undefined process')</td></tr>
<tr class="separator:a06419bdc055688700361394430138509"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:a89468c0136edff99d9ac22d5fb31a236"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a89468c0136edff99d9ac22d5fb31a236">save_list_of_obj</a> (objects_to_insert, filename)</td></tr>
<tr class="separator:a89468c0136edff99d9ac22d5fb31a236"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-attribs"></a>
Static Public Attributes</h2></td></tr>
<tr class="memitem:a71f015d744748095fd8c47d49b0bfcfa"><td class="memItemLeft" align="right" valign="top">list&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a71f015d744748095fd8c47d49b0bfcfa">ATTRIBUTES_FOR_MERGING_SAME_DSORF</a></td></tr>
<tr class="separator:a71f015d744748095fd8c47d49b0bfcfa"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><h1><a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html">MergeStrategy</a> </h1>
<p>This class is a strategy aiming to create a new PRO database by merging the data from the DS database. </p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a13ba6c2d12de752a21b7ec2717553b0d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a13ba6c2d12de752a21b7ec2717553b0d">&#9670;&nbsp;</a></span>__init__()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.__init__ </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>Constructor of <a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html">MergeStrategy</a> </h2>
<p>Instance variables:</p><ul>
<li>configfile: String - The path to the config file.</li>
<li>species: String - The name of the species in the database.</li>
<li>sqce_consensus_ambig_threshold: Float[0,1] - The threshold to use to compute the sequence consensus interval.</li>
<li>max_len_diff_dsota_clust: Integer (&gt;0) - The maximal difference between the max. and min. lengths of DSORFTranscriptAsso entries to belong to the same "cluster".</li>
<li>thread_nb: Integer (&gt;0) - The number of threads that can be use.</li>
</ul>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">DenCellORFException</td><td>When the config file is not provided or cannot be found at the path provided. </td></tr>
    <tr><td class="paramname">DenCellORFException</td><td>If the number of threads provided is not an integer. </td></tr>
    <tr><td class="paramname">DenCellORFException</td><td>If the number of threads provided is not a positive integer. </td></tr>
  </table>
  </dd>
</dl>

<p>Reimplemented in <a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1ResumeMergeStrategy_1_1ResumeMergeStrategy.html#ad141da10fb02355c32eb2d1a399d1113">fr.tagc.uorf.core.execution.ResumeMergeStrategy.ResumeMergeStrategy</a>.</p>
<div class="fragment"><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keyword">def </span>__init__( self ):</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        configfile = OptionManager.get_instance().get_option( OptionConstants.OPTION_CONFIG_FILE_PATH, not_none=<span class="keyword">True</span> )</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="keywordflow">if</span> configfile:</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            self.configfile = configfile</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists( configfile ):</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;No config file may be found at the path provided (&#39;</span> + </div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                                           self.configfile + <span class="stringliteral">&#39;).&#39;</span> )</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            self.parse_config()</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;            <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;A config file has to be provided.&#39;</span> +</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                                       <span class="stringliteral">&#39; See the documentation for more information.&#39;</span> )</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;            </div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="comment"># Check if the checkDSOTA option has been selected</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="keywordflow">if</span> OptionManager.get_instance().get_option( OptionConstants.OPTION_CHECK_DSOTA_COHERENCE, not_none = <span class="keyword">False</span> ):</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            self.check_dsota_coherence = <span class="keyword">True</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            self.check_dsota_coherence = <span class="keyword">False</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;            </div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="comment"># Check if the computeConsensus option has been selected</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="keywordflow">if</span> OptionManager.get_instance().get_option( OptionConstants.OPTION_COMPUTE_SQCE_CONSENSUS, not_none = <span class="keyword">False</span> ):</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;            self.compute_consensus = <span class="keyword">True</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;            self.compute_consensus = <span class="keyword">False</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;            </div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="comment"># Get the number of threads available</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        self.thread_nb = OptionManager.get_instance().get_option( OptionConstants.OPTION_THREAD_NB, </div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                                                                  not_none = <span class="keyword">False</span> )</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        available_thread_nb = cpu_count()</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        <span class="keywordflow">if</span> self.thread_nb:</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                self.thread_nb = int( self.thread_nb )</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            <span class="keywordflow">except</span>:</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;MergeStrategy: The value provided for the number of threads&#39;</span> +</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                                           <span class="stringliteral">&#39; needs to be an integer (provided value: &#39;</span> + </div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                                           str( self.thread_nb ) + <span class="stringliteral">&#39;).&#39;</span> )</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                <span class="keywordflow">if</span> ( self.thread_nb &lt; 1 ):</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                    <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;MergeStrategy: The value provided for the number of threads&#39;</span> +</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                                               <span class="stringliteral">&#39; needs to be an integer greater than 1 (provided value: &#39;</span> + </div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                                               str( self.thread_nb ) + <span class="stringliteral">&#39;).&#39;</span> )</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                    </div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                <span class="keywordflow">if</span> ( self.thread_nb &gt; available_thread_nb ):</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                    Logger.get_instance().info( <span class="stringliteral">&#39;The number of threads provided (&#39;</span> + str( self.thread_nb ) +</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                                                <span class="stringliteral">&#39;) is greater than the number of threads actually&#39;</span> +</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                                                <span class="stringliteral">&#39; available(&#39;</span> +  str( available_thread_nb ) +</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                                                <span class="stringliteral">&#39;). Hence, &#39;</span> + str( available_thread_nb ) +</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                                                <span class="stringliteral">&#39; threads will be used for the computation.&#39;</span> )</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            self.thread_nb = available_thread_nb</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            </div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy: &#39;</span> + str( self.thread_nb ) + </div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                                     <span class="stringliteral">&#39; threads will be used during the merging.&#39;</span> )</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a06419bdc055688700361394430138509"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a06419bdc055688700361394430138509">&#9670;&nbsp;</a></span>batch_insert_to_PRO_db()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.batch_insert_to_PRO_db </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>objects_to_insert</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>process</em> = <code>'Undefined&#160;process'</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>batch_insert_to_PRO_db </h2>
<p>This method allows to insert a list of objects in the PRO database.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">objects_to_insert</td><td>List - The list of objects to insert in the database. </td></tr>
    <tr><td class="paramname">filename</td><td>String - The name of the filename where data are saved. </td></tr>
    <tr><td class="paramname">process</td><td>String - The name of the process that generated these objects. 'Undefined process' by default. </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;    <span class="keyword">def </span>batch_insert_to_PRO_db( self, objects_to_insert, filename, process=&#39;Undefined process&#39; ):</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;        </div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;        <span class="comment"># Save into a temporary file the data that should be inserted.</span></div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;        self.save_list_of_obj( objects_to_insert = objects_to_insert, </div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;                               filename = filename )</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;            </div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;        <span class="comment"># Insert the objects in the database</span></div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;        SQLManagerPRO.get_instance().batch_insert_to_db( objects_to_insert = objects_to_insert, </div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;                                                         process = process )</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;    </div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;    </div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;    </div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;    </div></div><!-- fragment -->
</div>
</div>
<a id="a9f9c6169557031f5ff1c270f3761d060"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9f9c6169557031f5ff1c270f3761d060">&#9670;&nbsp;</a></span>clean_pro_database()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.clean_pro_database </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>clean_pro_database </h2>
<p>This method aims to clean the PRO database by removing all the parent entries of the ORF and Transcript tables that have no child in the ORFTranscriptAsso table.</p>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">DenCellORFException</td><td>When an exception has been raised trying to delete the entries of the ORF table without children. </td></tr>
    <tr><td class="paramname">DenCellORFException</td><td>When an exception has been raised trying to delete the entries of the Transcript table without children. </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;    <span class="keyword">def </span>clean_pro_database( self ):</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;        </div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Starting to clean the PRO database.&#39;</span>)</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;        </div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;        <span class="comment"># Delete all ORF entries without ORFTranscriptAsso children</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;        <span class="comment"># NB: The ORFDSAsso entries related to these are expected to be </span></div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;        <span class="comment">#     automatically removed in regard to the relational integrity</span></div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;        orf_wo_children_query = SQLManagerPRO.get_instance().get_session().query( ORF ).filter( ORF.ORFTranscriptAsso_list == <span class="keywordtype">None</span> )</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;        orf_wo_children_count = orf_wo_children_query.count()</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;        </div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;        <span class="keywordflow">if</span> ( orf_wo_children_count != 0 ):</div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;            Logger.get_instance().info( str( orf_wo_children_count ) + <span class="stringliteral">&#39; entries of the ORF table&#39;</span> +</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;                                        <span class="stringliteral">&#39; have been found without children and will be deleted.&#39;</span> )</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;                orf_wo_children_query.delete( synchronize_session=<span class="stringliteral">&#39;fetch&#39;</span> )</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;                SQLManagerPRO.get_instance().commit()</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;            <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;                <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;MergeStrategy.clean_pro_database(): An error occurred trying&#39;</span> +</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;                                           <span class="stringliteral">&#39; to remove the ORF entries without children from the session&#39;</span> +</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;                                           <span class="stringliteral">&#39; and to commit changes.&#39;</span>, e )</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;        </div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;        <span class="comment"># Delete all Transcript entries without ORFTranscriptAsso children</span></div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;        <span class="comment"># NB: The TranscriptDSAsso entries related to these are expected to be </span></div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;        <span class="comment">#     automatically removed in regard to the relational integrity</span></div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;        transcript_wo_children_query = SQLManagerPRO.get_instance().get_session().query( Transcript ).filter( Transcript.ORFTranscriptAsso_list == <span class="keywordtype">None</span> )</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;        transcript_wo_children_count = transcript_wo_children_query.count()</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;        </div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;        <span class="keywordflow">if</span> ( transcript_wo_children_count != 0 ):</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;            Logger.get_instance().info( str( transcript_wo_children_count ) + <span class="stringliteral">&#39; entries of the Transcript&#39;</span> +</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;                                        <span class="stringliteral">&#39; table have been found without children and will be deleted.&#39;</span> )</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;                transcript_wo_children_query.delete( synchronize_session = <span class="stringliteral">&#39;fetch&#39;</span> )</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;                SQLManagerPRO.get_instance().commit()</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;            <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;                <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;MergeStrategy.clean_pro_database(): An error occurred trying&#39;</span> +</div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;                                           <span class="stringliteral">&#39; to remove the Transcript entries without children from the&#39;</span> +</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;                                           <span class="stringliteral">&#39; session and to commit changes.&#39;</span>, e )</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;                </div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;                    </div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;        </div></div><!-- fragment -->
</div>
</div>
<a id="a8aa4cf77691658b414a5a109a3cef0a2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8aa4cf77691658b414a5a109a3cef0a2">&#9670;&nbsp;</a></span>copy_conserved_tables()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.copy_conserved_tables </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>copy_conserved_tables </h2>
<p>This methods aims to "copy" the content of the DS database tables for which there is no need to merge the data, into the PRO database. The content of the following tables is treated:</p><ul>
<li>Metadata table (copied into PROMetadata)</li>
<li>Gene table (copied into PROGene)</li>
<li>GeneAlias table (copied into PROGeneAlias)</li>
</ul>
<p>NB: For some of these entries, only a part of the attributes is copied. </p>
<div class="fragment"><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <span class="keyword">def </span>copy_conserved_tables( self ):</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        </div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        </div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        </div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        <span class="comment"># The entries of these tables are just copied from the DS database</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="comment"># to the corresponding tables of the PRO database.</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        </div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Copying the entries of the gene-related and metadata-related&#39;</span> +</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                                    <span class="stringliteral">&#39; tables into the PRO database.&#39;</span>)</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        objects_to_insert = []</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                    </div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        <span class="comment"># Copy all the Metadata entries</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        ds_metadata_all = SQLManagerDS.get_instance().get_session().query( Metadata ).all()</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        </div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <span class="keywordflow">for</span> ds_metadata <span class="keywordflow">in</span> ds_metadata_all:</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;            pro_metadata = PROMetadata( parameter = ds_metadata.parameter,</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                                        value = ds_metadata.value,</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                                        description = ds_metadata.description )        </div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            objects_to_insert.append( pro_metadata )</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        </div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;        </div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        <span class="comment"># Copy all the Gene entries</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        ds_gene_all = SQLManagerDS.get_instance().get_session().query( Gene ).all()</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        </div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        <span class="keywordflow">for</span> ds_gene <span class="keywordflow">in</span> ds_gene_all:</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;            pro_gene = PROGene( gene_id = ds_gene.gene_id,</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                                chromosome = ds_gene.chromosome )            </div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;            objects_to_insert.append( pro_gene )</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        </div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        </div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="comment"># Copy all the GeneAlias entries</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        ds_genealias_all = SQLManagerDS.get_instance().get_session().query( GeneAlias ).all()</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        </div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="keywordflow">for</span> ds_genealias <span class="keywordflow">in</span> ds_genealias_all:</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;            pro_genealias = PROGeneAlias( gene_id = ds_genealias.gene_id,</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                                          alias = ds_genealias.alias )            </div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            objects_to_insert.append( pro_genealias )</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;            </div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        </div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        <span class="comment"># Insert the newly created objects in the database</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        self.batch_insert_to_PRO_db( objects_to_insert = objects_to_insert,</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                                     filename = <span class="stringliteral">&#39;conserved_tables&#39;</span>,</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                                     process = <span class="stringliteral">&#39;copy the content of the &quot;conserved&quot; tables&#39;</span> )</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        SQLManagerDS.get_instance().close_session()</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        </div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;The entries of the gene and metadata tables have been copied.&#39;</span>)</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    </div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    </div></div><!-- fragment -->
</div>
</div>
<a id="a1cea36b0b441a121fd33ff5fc0194242"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1cea36b0b441a121fd33ff5fc0194242">&#9670;&nbsp;</a></span>execute()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.execute </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>execute </h2>
<p>Execute the strategy to complete missing information and merge the data.</p>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">DenCellORFException</td><td>When an exception has been raised during the DatabaseCheck. </td></tr>
    <tr><td class="paramname">DenCellORFException</td><td>When the DSORFTranscriptAsso table does not contain any entry. </td></tr>
    <tr><td class="paramname">DenCellORFException</td><td>When the DSORF table does not contain any entry with start position coordinates. </td></tr>
    <tr><td class="paramname">DenCellORFException</td><td>When the PRO database is not empty. </td></tr>
  </table>
  </dd>
</dl>

<p>Reimplemented in <a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1ResumeMergeStrategy_1_1ResumeMergeStrategy.html#a2e6864d7b3ff5842ef45d3ee102018b2">fr.tagc.uorf.core.execution.ResumeMergeStrategy.ResumeMergeStrategy</a>.</p>
<div class="fragment"><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="keyword">def </span>execute( self ):</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        </div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="comment"># Run DatabaseCheck in order to check the DS and PRO databases </span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        <span class="comment"># are reachable prior to the merging of data</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Checking the databases prior to the merging step...&#39;</span> )</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            DatabaseCheckStrategy().execute()</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;            <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;An error occurred whilst checking the database prior to&#39;</span> +</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                                       <span class="stringliteral">&#39; merging step.&#39;</span> +</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                                       <span class="stringliteral">&#39;\n Error code: &#39;</span> + LogCodes.ERR_DBCHECK + <span class="stringliteral">&#39;.&#39;</span>, e )</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        </div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        </div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        <span class="comment"># Check there is at least one DSORFTranscriptAsso entry </span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="comment"># in the database prior to merge the data.</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        dsorftranscriptasso_count = SQLManagerDS.get_instance().get_session().query( DSORFTranscriptAsso ).count()</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        SQLManagerDS.get_instance().close_session()</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        </div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        <span class="keywordflow">if</span> ( dsorftranscriptasso_count == 0 ):</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;There is not any entry found in the DSORFTranscriptAsso&#39;</span> +</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                                       <span class="stringliteral">&#39; table of the &#39;</span> + SQLManagerDS.get_instance().get_db_name() + </div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                                       <span class="stringliteral">&#39; database (DS database). Hence, the merging of data will&#39;</span> +</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                                       <span class="stringliteral">&#39; be stopped.&#39;</span> )</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        </div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        </div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="comment"># Check if the lift over has been performed (check on the start position)</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        dsorf_with_liftov_coord_count = SQLManagerDS.get_instance().get_session().query( DSORF ).filter( DSORF.start_pos != <span class="keywordtype">None</span> ).count()</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        SQLManagerDS.get_instance().close_session()</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        </div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="keywordflow">if</span> ( dsorf_with_liftov_coord_count == 0 ):</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;It seems that the lift over has not been performed on the&#39;</span> +</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                                       <span class="stringliteral">&#39; DS database. Make sure to run the LiftOver strategry prior to use&#39;</span> +</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                                       <span class="stringliteral">&#39; the MergeStrategy (see the documentation for more information).&#39;</span> +</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                                       <span class="stringliteral">&#39; The merging of data will thus be stopped.&#39;</span> )</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        </div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        </div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        <span class="comment"># Check there is no entries in the tables of the PRO database prior to merge the data.</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        progene_count = SQLManagerPRO.get_instance().get_session().query( PROGene ).count()</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        prometadata_count = SQLManagerPRO.get_instance().get_session().query( PROMetadata ).count()</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        orf_count = SQLManagerPRO.get_instance().get_session().query( ORF ).count()</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        transcript_count = SQLManagerPRO.get_instance().get_session().query( Transcript ).count()</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        orftranscriptasso_count = SQLManagerPRO.get_instance().get_session().query( ORFTranscriptAsso ).count()</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        </div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        <span class="keywordflow">if</span> ( progene_count, prometadata_count, orf_count, transcript_count, orftranscriptasso_count ) != ( 0, 0, 0, 0, 0 ):</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;            <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;Entries have been found in the PRO database.&#39;</span> +</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                                       <span class="stringliteral">&#39; Make sure to use an empty PRO database prior to run the merge&#39;</span> +</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                                       <span class="stringliteral">&#39; strategy or to use the &quot;-f&quot; option.&#39;</span> +</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                                       <span class="stringliteral">&#39; Please see the documentation for more information.&#39;</span> )</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;            </div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        <span class="comment"># Register the name of the DS database used to create the PRO one</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        metadata_ds_db_name = PROMetadata( parameter = Constants.METATABLE_DS_ORIGIN,</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                                           value = SQLManagerDS.get_instance().get_db_name(),</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                                           description = Constants.METATABLE_DS_ORIGIN_DESCRIPTION )</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        SQLManagerPRO.get_instance().get_session().add( metadata_ds_db_name )</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        SQLManagerPRO.get_instance().commit()</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        </div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        <span class="comment"># Regroup the same ORFs together</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;        self.copy_conserved_tables()</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        </div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        <span class="comment"># Regroup the same ORFs together</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        self.merge_dsorfs()</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        </div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        <span class="comment"># Regroup the same transcripts together</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        self.merge_dstranscripts()</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        </div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        <span class="comment"># Recover all the DSORFTranscriptAsso, </span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="comment"># and associate them with their actual ORFs and transcript</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        self.merge_dsorftranscriptasso()</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        </div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        <span class="comment"># Clean the database by removing parent entries that have no child</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        self.clean_pro_database()</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        </div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    </div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    </div></div><!-- fragment -->
</div>
</div>
<a id="a8b12d5286400a811fc83c1f86c25e74d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8b12d5286400a811fc83c1f86c25e74d">&#9670;&nbsp;</a></span>get_dsorftranscriptasso_to_merge()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.get_dsorftranscriptasso_to_merge </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>get_dsorftranscriptasso_to_merge </h2>
<p>This method allows to generate a dictionary that associates to each unique ( ORF ID (PRO), Transcript ID (PRO) ) couple that exists, a list of all the DSORFTranscriptAsso (DS) that are related to it; and to store this dictionary in the DataManager main dictionary. </p>
<div class="fragment"><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;    <span class="keyword">def </span>get_dsorftranscriptasso_to_merge( self ):</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;        </div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;        <span class="comment"># NB: This step is multi-processed</span></div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;        <span class="comment">#     - As access of objects shared by the several processes (using locks and </span></div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        <span class="comment">#       semaphores for instance), could slower a lot the speed of execution when the</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;        <span class="comment">#       process regularly need to access these variables, it has been decided to do</span></div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        <span class="comment">#       not access to shared resources. Then the progression bar is not displayed on </span></div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        <span class="comment">#       screen for this step.</span></div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;        </div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;        <span class="comment"># Instantiate a dictionary in the Data Manager that get as:</span></div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;            <span class="comment"># - keys the ( ORF ID (PRO), Transcript ID (PRO) ) couples that exist,</span></div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;            <span class="comment"># - values the list of all DSORFTranscriptAsso (DS) related to these ORF and Transcript IDs.</span></div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.get_dsorftranscriptasso_to_merge():&#39;</span> +</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;                                     <span class="stringliteral">&#39; Getting all the existing ( ORF ID, Transcript ID ) couples&#39;</span> +</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;                                     <span class="stringliteral">&#39; and the list of DSORFTranscriptAsso IDs corresponding to these.&#39;</span> +</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;                                     <span class="stringliteral">&#39; This might take some time...&#39;</span> )</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;        </div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        <span class="comment"># Get all the entries of the ORFDSAsso (PRO) table and build a dictionary</span></div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        <span class="comment"># that associate to each DSORF ID (DS) the related ORF IDs (PRO)</span></div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;        <span class="comment"># NB: This allows to avoid making highly numerous queries to the PRO database, </span></div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;        <span class="comment">#     allowing to shorten the computation time.</span></div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;        orfdsasso_groupby_orfid = SQLManagerPRO.get_instance().get_session().query( </div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;                                                                                        ORFDSAsso.dsorf_id,</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;                                                                                        func.group_concat( ORFDSAsso.orf_id ) </div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;                                                                                    ).group_by(</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;                                                                                                    ORFDSAsso.dsorf_id</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;                                                                                                ).all()</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;        </div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;        orfdsasso_dict = {}</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;        <span class="keywordflow">for</span> orfdsasso <span class="keywordflow">in</span> orfdsasso_groupby_orfid:</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;            dsorf_id = orfdsasso[ 0 ]</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;            orf_ids = orfdsasso[ 1 ].split( <span class="stringliteral">&#39;,&#39;</span> )</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;            orfdsasso_dict[ dsorf_id ] = orf_ids</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;                </div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;        <span class="comment"># Get all the entries of the TranscriptDSAsso (PRO) table and build a dictionary </span></div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;        <span class="comment"># that associate to each DSTranscript ID (DS) the related Transcript IDs (PRO)</span></div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;        <span class="comment"># NB: This allows to avoid making highly numerous queries to the PRO database, </span></div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;        <span class="comment">#     allowing to shorten the computation time.</span></div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;        transcriptdsasso_groupby_trid = SQLManagerPRO.get_instance().get_session().query(</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;                                                                                            TranscriptDSAsso.dstranscript_id,</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;                                                                                            func.group_concat( TranscriptDSAsso.transcript_id )</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;                                                                                        ).group_by(</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                                                                                                        TranscriptDSAsso.dstranscript_id</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;                                                                                                    ).all()</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;        </div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;        transcriptdsasso_dict = {}</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        <span class="keywordflow">for</span> transcriptdsasso <span class="keywordflow">in</span> transcriptdsasso_groupby_trid:</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;            dstranscript_id = transcriptdsasso[ 0 ]</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;            transcript_ids = transcriptdsasso[ 1 ].split( <span class="stringliteral">&#39;,&#39;</span> )</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;            transcriptdsasso_dict[ dstranscript_id ] = transcript_ids</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;        </div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;        </div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;        <span class="comment"># Get all the DSORFTranscriptAsso entries (DS database)</span></div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;        dsota_query = SQLManagerDS.get_instance().get_session().query( DSORFTranscriptAsso )</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;        dsota_all = dsota_query.all()</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;        SQLManagerDS.get_instance().close_session()</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;        </div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;        <span class="comment"># Create a list of 3-element tuples containing:</span></div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;        <span class="comment"># - The ORFTranscriptAsso object</span></div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;        <span class="comment"># - The value of the orf_id attribute</span></div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;        <span class="comment"># - The value of the transcript_id attribute</span></div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;        dsota_ids_asso_list = [ ( dsota, dsota.uniq_orf_id, dsota.transcript_id ) <span class="keywordflow">for</span> dsota <span class="keywordflow">in</span> dsota_all ]</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;        </div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;        <span class="comment"># Replace each element of the list by a 3-elements list </span></div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;        <span class="comment"># that contains:</span></div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;        <span class="comment"># - The ORFTranscriptAsso object</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;        <span class="comment"># - The list of ORF IDs (PRO) related to it </span></div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;        <span class="comment">#   (or an empty list if the DSORF ID is not used in the PRO database)</span></div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;        <span class="comment"># - The list of Transcript IDs (PRO) related to it</span></div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;        <span class="comment">#   (or an empty list if the DSTranscript ID is not used in the PRO database)</span></div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;        dsota_ids_asso_list = map( <span class="keyword">lambda</span> t: [ t[0], </div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;                                               orfdsasso_dict.get( t[1], [] ), </div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;                                               transcriptdsasso_dict.get( t[2], [] ) ], </div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;                                   dsota_ids_asso_list )</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;        </div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;        <span class="comment"># Compute the Cartesian product of ORF and Transcript lists of IDs</span></div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;        <span class="comment"># i.e. compute all the tuples of ( ORF, Transcript ) IDs (PRO) that </span></div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;        <span class="comment"># are associated to this DSORFTranscriptAsso (DS) and add it as the </span></div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;        <span class="comment"># fourth element of each lists.</span></div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        dsota_ids_asso_list = map( <span class="keyword">lambda</span> t: t + [ list( itertools.product( t[1], t[2] ) ) ],</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;                                   dsota_ids_asso_list )</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;        </div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;        <span class="comment"># Create a dictionary that associate to each unique ( ORF id (PRO), Transcript ID (PRO) )</span></div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;        <span class="comment"># the list of DSORFTranscriptAsso (DS) to merge</span></div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        DataManager.get_instance().store_data( Constants.DM_ALL_EXISTING_ORF_TR_ASSO_DICT, {} )</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;        all_existing_orf_tr_asso_dict = DataManager.get_instance().get_data( Constants.DM_ALL_EXISTING_ORF_TR_ASSO_DICT )</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;        </div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;        <span class="keywordflow">for</span> t <span class="keywordflow">in</span> dsota_ids_asso_list:</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;            dsota = t[0]</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;            cartesian_prod = t[3]</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;            </div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;            <span class="keywordflow">for</span> ( orf_id, tr_id ) <span class="keywordflow">in</span> cartesian_prod:</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;                exist_orf_tr_asso = all_existing_orf_tr_asso_dict.get( ( orf_id, tr_id ) ) </div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;                <span class="keywordflow">if</span> exist_orf_tr_asso:</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;                    exist_orf_tr_asso.append( dsota )</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;                    all_existing_orf_tr_asso_dict[ ( orf_id, tr_id ) ] = [ dsota ]</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;        </div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;        </div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;        <span class="comment"># Compute the dictionary that associate to each DSORFTranscriptAsso</span></div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;        <span class="comment"># the number of ORF and Transcript related to it.</span></div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;        <span class="comment"># NB: This dictionary is absolutely NOT necessary to perform the merging</span></div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;        <span class="comment">#     but will be saved in a csv file for further analysis.</span></div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;        all_orf_tr_count_for_dsota_dict = { dsota.id : ( len( orf_ids ),</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;                                                         len( transcript_ids ),</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;                                                         len( orf_tr_asso_list ) ) \</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;                                            <span class="keywordflow">for</span> (dsota, orf_ids, transcript_ids, orf_tr_asso_list ) <span class="keywordflow">in</span> dsota_ids_asso_list }</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;        </div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;        </div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        <span class="comment"># From the &#39;all_existing_orf_tr_asso_dict&#39; dictionary, compute a new dictionary that </span></div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;        <span class="comment"># associate to each ( ORF ID (PRO), Transcript ID (PRO) ) couple, the  list of </span></div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;        <span class="comment"># DSORFTranscriptAsso IDs (DS) related to it and save it into a file. </span></div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;        <span class="comment"># This file may then be used by the ResumeMerge strategy to re-start the </span></div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;        <span class="comment"># merging after the computation of these couples if something goes wrong during</span></div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;        <span class="comment"># the execution of the merge_dsota() method.</span></div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;Starting to compute the dictionary that associates the ( ORF (PRO),&#39;</span> +</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;                                     <span class="stringliteral">&#39; Transcript (PRO) ) IDs to the lists of DSORFTranscriptAsso (DS) IDs.&#39;</span> )</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;        all_existing_orf_tr_asso_ids = {}</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        <span class="keywordflow">for</span> ( ( orf_id, tr_id ), dsota_list ) <span class="keywordflow">in</span> all_existing_orf_tr_asso_dict.items():</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;            all_existing_orf_tr_asso_ids[ ( orf_id, tr_id ) ] = map( <span class="keyword">lambda</span> x: x.id, dsota_list )</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;            </div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;            FileHandlerUtil.save_obj_to_file( objects_to_save = all_existing_orf_tr_asso_ids, </div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;                                              filename = Constants.ALL_EXISTING_ORF_TR_ASSO_IDS_FILENAME, </div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;                                              output_folder = Constants.MERGED_DATA_FOLDER )</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;            Logger.get_instance().error( <span class="stringliteral">&#39;An error occurred trying to save the dictionary that associates&#39;</span> +</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;                                         <span class="stringliteral">&#39; to each (ORF ID (PRO), Transcript ID (PRO) ) couple the IDs of&#39;</span> +</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;                                         <span class="stringliteral">&#39; the list of DSORFTranscriptAsso related to it. \n&#39;</span> +</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;                                         str( e )  +</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;                                         <span class="stringliteral">&#39; Error code: &#39;</span> + LogCodes.ERR_FILEHAND + <span class="stringliteral">&#39;.&#39;</span>, </div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;                                         ex = <span class="keyword">False</span> )</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;        </div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;        </div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;        <span class="comment"># Store into an other data frame the number of DSORFTranscriptAsso (DS) </span></div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;        <span class="comment"># associated with each existing ( ORF (PRO), Transcript (PRO) ) tuple</span></div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;Computing the number of DSORFTranscriptAsso (DS) associated&#39;</span> +</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;                                     <span class="stringliteral">&#39; with each existing ( ORF (PRO), Transcript (PRO) ) tuple.&#39;</span> )</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;        dsota_count_for_orf_tr_df = pd.DataFrame( columns = [ <span class="stringliteral">&#39;orf_id&#39;</span>, </div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;                                                             <span class="stringliteral">&#39;transcript_id&#39;</span>, </div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;                                                             <span class="stringliteral">&#39;dsota_count&#39;</span> ] )</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;        </div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;        dsota_count_for_orf_tr_dict = { ( orf_id, tr_id ) : len( dsota_list ) \</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;                                        <span class="keywordflow">for</span> ( ( orf_id, tr_id ), dsota_list ) <span class="keywordflow">in</span> all_existing_orf_tr_asso_dict.items() }</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;        </div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;        <span class="comment"># Save the data frames in CSV files</span></div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;The number of ORF (PRO) and Transcript (PRO) entries associated&#39;</span> +</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;                                    <span class="stringliteral">&#39; with each existing DSORFTranscriptAsso (DS) will be saved in a&#39;</span> +</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;                                    <span class="stringliteral">&#39; CSV file (&#39;</span> + Constants.MERGE_DATA_ANALYSIS_FOLDER +</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;                                    <span class="stringliteral">&#39; folder, orf_tr_count_for_dsota.csv file).&#39;</span> )</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;            FileHandlerUtil.dict_to_csv( output_folder = Constants.MERGE_DATA_ANALYSIS_FOLDER,</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;                                         filename = <span class="stringliteral">&#39;orf_tr_count_for_dsota&#39;</span>,</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;                                         file_desc = ( <span class="stringliteral">&#39;Number of ORF (PRO) and Transcript (PRO) entries&#39;</span> +</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;                                                       <span class="stringliteral">&#39; associated with each DSORFTranscriptAsso (DS)&#39;</span> ),</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;                                         dict = all_orf_tr_count_for_dsota_dict,</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;                                         hdr = [ <span class="stringliteral">&#39;dsota_id&#39;</span>, </div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;                                                 <span class="stringliteral">&#39;orf_count&#39;</span>, </div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;                                                 <span class="stringliteral">&#39;transcript_count&#39;</span>, </div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;                                                 <span class="stringliteral">&#39;cartesian_prod_count&#39;</span> ],</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;                                         val_func = <span class="keyword">lambda</span> v: map( str, v ),</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;                                         sep = <span class="stringliteral">&#39;,&#39;</span>,</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;                                         sort = <span class="keyword">True</span>, </div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;                                         unlist_val = <span class="keyword">True</span> )</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;            Logger.get_instance().error( <span class="stringliteral">&#39;An error occurred trying to save the number of ORF (PRO)&#39;</span> +</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;                                         <span class="stringliteral">&#39; and Transcript (PRO) entries associated with each existing&#39;</span> +</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;                                         <span class="stringliteral">&#39; DSORFTranscriptAsso (DS) in the CSV file. \n&#39;</span> +</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;                                         str( e ) +</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;                                         <span class="stringliteral">&#39; Error code: &#39;</span> + LogCodes.ERR_FILEHAND + <span class="stringliteral">&#39;.&#39;</span>,</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;                                         ex = <span class="keyword">False</span> )</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;        </div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;The number of DSORFTranscriptAsso (DS) associated with each&#39;</span> +</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;                                    <span class="stringliteral">&#39; ( ORF (PRO), Transcript (PRO) ) existing tuple will be saved&#39;</span> +</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;                                    <span class="stringliteral">&#39; in a CSV file (&#39;</span> + Constants.MERGE_DATA_ANALYSIS_FOLDER +</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;                                    <span class="stringliteral">&#39; folder, dsota_count_for_orf_tr.csv file).&#39;</span> )</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;            FileHandlerUtil.dict_to_csv( output_folder = Constants.MERGE_DATA_ANALYSIS_FOLDER,</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;                                         filename = <span class="stringliteral">&#39;dsota_count_for_orf_tr&#39;</span>, </div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;                                         file_desc = ( <span class="stringliteral">&#39;Number of DSORFTranscriptAsso (DS) associated with&#39;</span> +</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;                                                       <span class="stringliteral">&#39; each ( ORF (PRO), Transcript (PRO) ) existing tuple&#39;</span> ),</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;                                         dict = dsota_count_for_orf_tr_dict,</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;                                         hdr = [ <span class="stringliteral">&#39;orf_id&#39;</span>,</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;                                                 <span class="stringliteral">&#39;transcript_id&#39;</span>,</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                                                 <span class="stringliteral">&#39;dsota_count&#39;</span> ],</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;                                         key_func = <span class="keyword">lambda</span> k: map( str, k ),</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;                                         sep = <span class="stringliteral">&#39;,&#39;</span>,</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                                         sort = <span class="keyword">True</span>,</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;                                         unlist_key = <span class="keyword">True</span> )</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;            Logger.get_instance().error( <span class="stringliteral">&#39;An error occurred trying to save the number of&#39;</span> +</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                                         <span class="stringliteral">&#39; DSORFTranscriptAsso (DS) associated with each&#39;</span> +</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;                                         <span class="stringliteral">&#39; ( ORF (PRO), Transcript (PRO) ) existing tuple in the CSV file. \n&#39;</span> +</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;                                         str( e ) +</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;                                         <span class="stringliteral">&#39; Error code: &#39;</span> + LogCodes.ERR_FILEHAND + <span class="stringliteral">&#39;.&#39;</span>,</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;                                         ex = <span class="keyword">False</span> )</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;        </div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;        </div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;            </div></div><!-- fragment -->
</div>
</div>
<a id="a853e3c9d47078794ecb829fb5185e638"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a853e3c9d47078794ecb829fb5185e638">&#9670;&nbsp;</a></span>merge_dsorfs()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.merge_dsorfs </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>merge_dsorfs </h2>
<p>This methods aims to merge the similar entries of the DSORF table (DS database) into new entries of the ORF table (PRO database). </p>
<div class="fragment"><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <span class="keyword">def </span>merge_dsorfs( self ):</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        </div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Starting to merge the entries of the DSORF table.&#39;</span>)</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        </div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        </div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                </div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="comment"># First, </span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        <span class="comment"># - Get the list of DSORFs regrouped by ORFs sharing the same values for </span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        <span class="comment">#   the following attributes: chromosome, strand, start position, stop position, </span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        <span class="comment">#   spliced, spliced parts count, splice starts and ends, AND such as the values </span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        <span class="comment">#   of ALL of these attributes are provided (i.e. not NULL).</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        <span class="comment"># - For each entry of the list (i.e. grouped DSORF entries), create a new ORF </span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        <span class="comment">#   entry in the PRO database</span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        <span class="comment">#</span></div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Starting to regroup the perfectly identical entries of the DSORF&#39;</span> +</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                                    <span class="stringliteral">&#39; table (DS database) into new ORF entries (PRO database).&#39;</span> )</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        </div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dsorfs(): Querying the DS database&#39;</span> +</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                                     <span class="stringliteral">&#39; to regroup the exact same ORFs together.&#39;</span>)</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        grouped_dsorf_wo_any_null_base_query = SQLManagerDS.get_instance().get_session().query(</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                                                                                                    DSORF.chromosome,</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                                                                                                    DSORF.strand,</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                                                                                                    DSORF.start_pos,</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                                                                                                    DSORF.stop_pos,</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                                                                                                    DSORF.spliced,</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                                                                                                    DSORF.spliced_parts_count,</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                                                                                                    DSORF.splice_starts,</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                                                                                                    DSORF.splice_ends,</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                                                                                                    func.group_concat( DSORF.id ),</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                                                                                                    func.group_concat( DSORF.data_source ),</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                                                                                                    func.count( DSORF.id )</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                                                                                                ).filter(</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                                                                                                            DSORF.chromosome != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                                                                                                            DSORF.strand != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                                                                                                            DSORF.start_pos != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                                                                                                            DSORF.stop_pos != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                                                                                                            DSORF.spliced != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                                                                                                            DSORF.spliced_parts_count != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                                                                                                            DSORF.splice_starts != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                                                                                                            DSORF.splice_ends != <span class="keywordtype">None</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                                                                                                        )</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        </div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <span class="comment"># If necessary, filter out all the DSORF entries that have a difference</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="comment"># between their genomic lengths exceeding the provided threshold</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        <span class="keywordflow">if</span> ( self.gen_len_diff_threshold != Constants.GEN_LEN_DIFF_THRESHOLD_IGNORE ):</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            grouped_dsorf_wo_any_null_excl_diff_ov_th = grouped_dsorf_wo_any_null_base_query.filter( </div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                                                                                                        DSORF.genomic_length_diff &lt; self.gen_len_diff_threshold </div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                                                                                                    )</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;            grouped_dsorf_wo_any_null_excl_diff_ov_th = grouped_dsorf_wo_any_null_base_query</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;            </div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        grouped_dsorf_wo_any_null_all = grouped_dsorf_wo_any_null_excl_diff_ov_th.group_by(</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                                                                                                DSORF.chromosome,</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                                                                                                DSORF.strand,</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                                                                                                DSORF.start_pos,</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                                                                                                DSORF.stop_pos,</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                                                                                                DSORF.spliced,</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                                                                                                DSORF.spliced_parts_count,</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                                                                                                DSORF.splice_starts,</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                                                                                                DSORF.splice_ends</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                                                                                            ).all()</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                    </div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                                                                               </div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="comment"># Get the number total number of elements expected to be treated and</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        <span class="comment"># reset the ProgressionBar instance to follow the progression</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        ProgressionBar.get_instance().reset_instance( total = len( grouped_dsorf_wo_any_null_all ) )</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        </div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        <span class="comment"># Keep track of the IDs of all DSORFs that have already been merged</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        grouped_dsorf_all_processed_ids = []</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                </div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        <span class="comment"># Instantiate the list of new objects to be added to the PRO database</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        objects_to_insert = []</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                         </div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        <span class="comment"># For each unique component of this list (i.e. each merged element, i.e. each ORF </span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        <span class="comment"># identified as unique), create a new ORF in the PRO database</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dsorfs(): Regrouping the perfectly&#39;</span> +</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                                     <span class="stringliteral">&#39; identical entries of the DSORF table (DS database) into&#39;</span> +</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                                     <span class="stringliteral">&#39; new ORF entries (PRO database).&#39;</span> )</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        </div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="comment"># NB: The merging of perfectly identical DSORF is multi-processed </span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        </div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        <span class="comment"># Instantiate the pool</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        p = Pool( self.thread_nb )</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        </div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        <span class="comment"># For each group of DSORF to merge, run the MergeDSORF.merge_exact_same_dsorf()</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <span class="comment"># static method that will instantiate all the appropriate ORF and ORFDSAsso to </span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <span class="comment"># insert in the PRO database</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        m = MergeDSORF()</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        all_objects_to_insert = p.map( m.merge_exact_same_dsorf, grouped_dsorf_wo_any_null_all )</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        p.close()</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        <span class="comment"># Wait for all processes to be completed</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        p.join()</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                </div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="comment"># Get the new objects to add to the session</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <span class="keywordflow">for</span> obj_to_insert <span class="keywordflow">in</span> all_objects_to_insert:</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            </div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;            ProgressionBar.get_instance().increase_and_display()</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            </div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            <span class="comment"># Parse the output of the MergeDSORF.merge_exact_same_dsorf() method</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;            <span class="comment"># and add the entries to the list to insert to the database</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;            ( new_objects, processed_ids ) = obj_to_insert</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        </div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;            objects_to_insert += new_objects</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;            grouped_dsorf_all_processed_ids += processed_ids           </div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        </div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        <span class="comment"># Delete the pool instance</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        p.clear()  </div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;            </div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        <span class="comment"># Insert the newly created objects in the database</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        self.batch_insert_to_PRO_db( objects_to_insert = objects_to_insert,</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                                     filename = <span class="stringliteral">&#39;exact_same_orfs&#39;</span>,</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                                     process = <span class="stringliteral">&#39;grouping exact same ORFs&#39;</span> )</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        SQLManagerDS.get_instance().close_session()</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;        </div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                    </div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        </div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        </div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        <span class="comment"># NB: This process is not multi-processed. Please see the documentation of the</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        <span class="comment">#     MergeDSORF class for more information.</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        </div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <span class="comment"># Then, </span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        <span class="comment"># - Excluding all the DSORF that have already been processed in the first step, </span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        <span class="comment">#   get the list of DSORFs regrouped by ORFs sharing the same values for the following </span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        <span class="comment">#   attributes: chromosome, strand, start position, stop position, spliced, spliced </span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <span class="comment">#   parts count, splice starts and ends, </span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        <span class="comment">#   AND such as the values of the following attributes are provided (i.e. not NULL): </span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        <span class="comment">#   chromosome, strand, start position stop position and spliced.</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        <span class="comment"># - For each entry of the list (i.e. grouped DSORF entries), if they can be merged </span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        <span class="comment">#   with one of the previously created ORF do it, otherwise, create a new entry.</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        <span class="comment">#</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Starting to regroup the identical entries of the DSORF&#39;</span> +</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                                    <span class="stringliteral">&#39; table (DS database) into new ORF entries (PRO database).&#39;</span> )</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        </div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dsorfs(): Querying the DS database&#39;</span> +</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                                     <span class="stringliteral">&#39; to regroup the same ORFs together.&#39;</span>)</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        </div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        grouped_dsorf_wo_null_base_query = SQLManagerDS.get_instance().get_session().query(</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                                                                                                DSORF.chromosome,</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                                                                                                DSORF.strand,</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                                                                                                DSORF.start_pos,</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                                                                                                DSORF.stop_pos,</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                                                                                                DSORF.spliced,</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                                                                                                DSORF.spliced_parts_count,</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                                                                                                DSORF.splice_starts,</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                                                                                                DSORF.splice_ends,</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                                                                                                func.group_concat( DSORF.id ),</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                                                                                                func.group_concat( DSORF.data_source ),</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                                                                                                func.count( DSORF.id )</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                                                                                            ).filter( </div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                                                                                                        DSORF.id.notin_( grouped_dsorf_all_processed_ids )</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                                                                                                    ).filter(</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                                                                                                                DSORF.chromosome != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                                                                                                                DSORF.strand != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                                                                                                                DSORF.start_pos != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                                                                                                                DSORF.stop_pos != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                                                                                                                or_( and_( DSORF.spliced == <span class="keyword">True</span>,</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                                                                                                                           DSORF.splice_starts != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                                                                                                                           DSORF.splice_ends != <span class="keywordtype">None</span> ),</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                                                                                                                     DSORF.spliced == <span class="keyword">False</span> )                                                                                                                     </div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                                                                                                            )</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        </div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        <span class="comment"># If necessary, filter out all the DSORF entries that have a difference</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        <span class="comment"># between their genomic lengths exceeding the provided threshold</span></div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        <span class="keywordflow">if</span> ( self.gen_len_diff_threshold != Constants.GEN_LEN_DIFF_THRESHOLD_IGNORE ):            </div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;            grouped_dsorf_wo_null_excl_diff_ov_th = grouped_dsorf_wo_null_base_query.filter( </div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                                                                                                or_( DSORF.genomic_length_diff &lt; self.gen_len_diff_threshold,</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                                                                                                     DSORF.genomic_length_diff == <span class="keywordtype">None</span> )</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                                                                                            )</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            grouped_dsorf_wo_null_excl_diff_ov_th = grouped_dsorf_wo_null_base_query</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;            </div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        grouped_dsorf_wo_null_all = grouped_dsorf_wo_null_excl_diff_ov_th.group_by(</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                                                                                        DSORF.chromosome,</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                                                                                        DSORF.strand,</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                                                                                        DSORF.start_pos,</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                                                                                        DSORF.stop_pos,</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                                                                                        DSORF.spliced,</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                                                                                        DSORF.spliced_parts_count,</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                                                                                        DSORF.splice_starts,</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                                                                                        DSORF.splice_ends,</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                                                                                    ).all()</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        </div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        </div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        <span class="comment"># For each unique component of this list (i.e. each merged element), </span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        <span class="comment"># check if there is an existing ORF entry sharing the same properties in the </span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        <span class="comment"># PRO database for all available properties.</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="comment"># If there are ORFs sharing the same properties in the PRO database, </span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        <span class="comment"># merge them together. Otherwise, create a new ORF entry in the PRO database.</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dsorfs(): Regrouping the same DSORFs&#39;</span> +</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                                     <span class="stringliteral">&#39; to merge them with existing ORF entries (PRO database)&#39;</span>+</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                                     <span class="stringliteral">&#39; or to create new ORF entries (PRO database).&#39;</span> )</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        </div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        <span class="comment"># Get the number total number of elements expected to be treated and </span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        <span class="comment"># reset the ProgressionBar instance to follow the progression</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        ProgressionBar.get_instance().reset_instance( total = len( grouped_dsorf_wo_null_all ) )</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        </div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        <span class="keywordflow">for</span> grouped_dsorf_wo_null <span class="keywordflow">in</span> grouped_dsorf_wo_null_all:</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        </div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            <span class="comment"># Update and display the progression bar on the console</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            ProgressionBar.get_instance().increase_and_display()</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;            </div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;            objects_to_insert = []</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;            </div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;            <span class="comment"># Parse the list to get the necessary attributes to instantiate an ORF object</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;            orf_chromosome = grouped_dsorf_wo_null[ 0 ]</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;            orf_strand = grouped_dsorf_wo_null[ 1 ]</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            orf_start_pos = grouped_dsorf_wo_null[ 2 ]</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            orf_stop_pos = grouped_dsorf_wo_null[ 3 ]</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            orf_spliced = grouped_dsorf_wo_null[ 4 ]</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            orf_spliced_parts_count = grouped_dsorf_wo_null[ 5 ]</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;            orf_splice_starts = grouped_dsorf_wo_null[ 6 ]</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;            orf_splice_ends = grouped_dsorf_wo_null[ 7 ]</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;            orf_related_dsorfs_ids = GeneralUtil.string_to_list( str_to_convert = grouped_dsorf_wo_null[ 8 ], </div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                                                                 fct = <span class="stringliteral">&#39;int&#39;</span> )</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;            orf_related_datasources = GeneralUtil.string_to_list( str_to_convert = grouped_dsorf_wo_null[ 9 ] )</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;            nb_of_dsorfs_grouped = grouped_dsorf_wo_null[ 10 ]</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                        </div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            <span class="comment"># Keep track of all the IDs regrouped in this ORF</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            grouped_dsorf_all_processed_ids += orf_related_dsorfs_ids</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;            </div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;            <span class="comment"># If there is already an ORF looking like this one in the database, </span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;            <span class="comment"># then merge these two ORFs i.e. create a new ORFDSAsso entry, keep </span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;            <span class="comment"># record of the relationship with the corresponding ORF, and increase </span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;            <span class="comment"># of one the count of (non-ambiguous) DSORFs associated to it.</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;            </div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;            <span class="comment"># Get the list of attributes which are not null for the current element </span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;            <span class="comment"># of the list (i.e. the elements that do not equal None) and that should </span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;            <span class="comment"># be used as filter to query the ORF table</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;            attributes_to_use_for_filter = {}</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;            </div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;            <span class="keywordflow">for</span> att <span class="keywordflow">in</span> MergeStrategy.ATTRIBUTES_FOR_MERGING_SAME_DSORF:</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                <span class="comment"># Get the value of the attribute</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                att_value = eval( <span class="stringliteral">&#39;orf_&#39;</span> + att )</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                <span class="comment"># Add the attribute as a filter to use only if it is not null</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                <span class="keywordflow">if</span> ( att_value != <span class="keywordtype">None</span> ):</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                    attributes_to_use_for_filter[ att ] = att_value</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;            </div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;            <span class="comment"># Query the PRO database to the the ORF(s) that look like the current entry</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;            existing_orf_query = SQLManagerPRO.get_instance().get_session().query( ORF )</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;            <span class="comment"># Sequentially apply the filters on the query</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            <span class="keywordflow">for</span> ( att, value ) <span class="keywordflow">in</span> attributes_to_use_for_filter.items():</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;                existing_orf_query = existing_orf_query.filter( eval( <span class="stringliteral">&#39;ORF.&#39;</span> + att ) == value )</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            </div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;            existing_orf = existing_orf_query.all()</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                                                                                            </div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;            <span class="comment"># If there is at least one ORF returned, i.e. if there is at least one </span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            <span class="comment"># ORF entry in the PRO database that may match the current element of the </span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            <span class="comment"># list, then merge the DSORF(s) of the current element of the list with each </span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;            <span class="comment"># of these ORF entries. In other words, for each ORF entry that matches with </span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;            <span class="comment"># the current DSORF(s), create a new ORFDSAsso entry, keep track of the </span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;            <span class="comment"># relationship to it and increase of one the count of DSORFs associated to it.</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            <span class="keywordflow">if</span> ( len( existing_orf ) &gt; 0 ):</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;                </div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;                <span class="keywordflow">for</span> orf <span class="keywordflow">in</span> existing_orf:</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                </div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                    <span class="comment"># Increase the DS count of one</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                    orf.count_ds += 1</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                    objects_to_insert.append( orf )</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                    </div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                    <span class="comment"># Create the new ORFDSAsso</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                    <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range( len( orf_related_dsorfs_ids ) ):</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;                        orfdsasso = ORFDSAsso( orf_id = orf.id,</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                                               dsorf_id = orf_related_dsorfs_ids[ k ],</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                                               data_source = orf_related_datasources[ k ],</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;                                               ambiguous = <span class="keyword">False</span> )</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                        objects_to_insert.append( orfdsasso )</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;            <span class="comment"># Otherwise create a new ORF entry, using the provided attributes</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                </div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                <span class="comment"># The lowest ID of all DSORFs regrouped will be used </span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                <span class="comment"># as unique ID of the new ORF object</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                orf_id = min( orf_related_dsorfs_ids )</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                </div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                <span class="comment"># Instantiate the new ORF object</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                orf = ORF( id = orf_id,</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;                           chromosome = orf_chromosome,</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;                           strand = orf_strand,</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;                           start_pos = orf_start_pos,</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;                           stop_pos = orf_stop_pos,</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                           spliced = orf_spliced,</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                           spliced_parts_count = orf_spliced_parts_count,</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;                           splice_starts = orf_splice_starts,</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;                           splice_ends = orf_splice_ends,</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                           count_ds = nb_of_dsorfs_grouped,</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                           count_ds_ambiguous = 0 )</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                objects_to_insert.append( orf )</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                </div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                <span class="comment"># Register in the ORFDSAsso table the relationship between this ORF and</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                <span class="comment"># the DSORF from which it derives</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range( len( orf_related_dsorfs_ids ) ):</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                    </div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                    orfdsasso = ORFDSAsso( orf_id = orf.id,</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                                           dsorf_id = orf_related_dsorfs_ids[ k ],</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                                           data_source = orf_related_datasources[ k ],</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                                           ambiguous = <span class="keyword">False</span> )</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                    objects_to_insert.append( orfdsasso )</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                </div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;            </div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;            <span class="comment"># Add the new objects to the session (PRO database), and flush the session</span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;            <span class="comment"># so the query on the next step will return up-to-date results</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;            SQLManagerPRO.get_instance().add_and_flush( objects_to_add = objects_to_insert, </div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                                                        process = <span class="stringliteral">&#39;grouping same ORFs&#39;</span> )</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        </div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        <span class="comment"># Commit the changes and close the session</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        SQLManagerPRO.get_instance().commit()</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;        SQLManagerDS.get_instance().close_session()</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                </div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        </div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                </div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        </div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        </div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <span class="comment"># NB: This process is not multi-processed. Please see the documentation of the</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        <span class="comment">#     MergeDSORF class for more information.</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;        </div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        <span class="comment"># Finally, </span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <span class="comment"># - Group all the DSORFs that have not already been processed in the previous </span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        <span class="comment">#   steps but sharing the same values for the following attributes:</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        <span class="comment">#   chromosome, strand, start position, stop position, spliced, </span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        <span class="comment">#   spliced parts count, splice starts and ends, </span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        <span class="comment">#   AND such as the chromosome name of the ORF is known </span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;        <span class="comment">#   AND for which at least two of the following attributes are provided (i.e. not NULL):</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        <span class="comment">#   strand, start, stop position</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        <span class="comment"># - For each entry of the list (i.e. grouped DSORF entries) , search if these DSORFs can</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        <span class="comment">#   be merged with one (some) of the previously created ORF entry (entries).</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <span class="comment">#</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Starting to regroup the similar entries of the DSORF&#39;</span> +</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                                    <span class="stringliteral">&#39; table (DS database) into existing ORF entries (PRO database).&#39;</span> )</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dsorfs(): Querying the DS database&#39;</span> +</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                                     <span class="stringliteral">&#39; to regroup the similar ORFs together.&#39;</span>)</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        </div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;        grouped_dsorf_all = SQLManagerDS.get_instance().get_session().query( </div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                                                                                DSORF.chromosome,</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                                                                                DSORF.strand,</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                                                                                DSORF.start_pos,</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                                                                                DSORF.stop_pos,</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                                                                                DSORF.spliced,</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                                                                                DSORF.spliced_parts_count,</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                                                                                DSORF.splice_starts,</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                                                                                DSORF.splice_ends,</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                                                                                func.group_concat( DSORF.id ),</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                                                                                func.group_concat( DSORF.data_source ),</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                                                                                func.count( DSORF.id )</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                                                                            ).filter( </div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                                                                                        DSORF.id.notin_( grouped_dsorf_all_processed_ids )</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                                                                                    ).filter(</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                                                                                                and_(</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                                                                                                        DSORF.chromosome != <span class="keywordtype">None</span>,</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                                                                                                        or_(</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                                                                                                                and_( DSORF.strand != <span class="keywordtype">None</span>, DSORF.start_pos != <span class="keywordtype">None</span> ),</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                                                                                                                and_( DSORF.strand != <span class="keywordtype">None</span>, DSORF.stop_pos != <span class="keywordtype">None</span> ),</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                                                                                                                and_( DSORF.start_pos != <span class="keywordtype">None</span>, DSORF.stop_pos != <span class="keywordtype">None</span> )</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;                                                                                                            )</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                                                                                                    )</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                                                                                            ).group_by(</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;                                                                                                        DSORF.chromosome,</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                                                                                                        DSORF.strand,</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;                                                                                                        DSORF.start_pos,</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                                                                                                        DSORF.stop_pos,</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                                                                                                        DSORF.spliced,</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                                                                                                        DSORF.spliced_parts_count,</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                                                                                                        DSORF.splice_starts,</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                                                                                                        DSORF.splice_ends,</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                                                                                                       ).all()</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                </div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        </div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        <span class="comment"># For each unique component of this list (i.e. each merged element), </span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        <span class="comment"># check if there is an ORF sharing the same (provided) properties </span></div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        <span class="comment"># in the PRO database</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dsorfs(): Regrouping the similar&#39;</span> +</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                                     <span class="stringliteral">&#39; entries of the DSORF table (DS database) with existing&#39;</span> +</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;                                     <span class="stringliteral">&#39; ORF entries (PRO database).&#39;</span> )</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;        </div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;        <span class="comment"># Get the number total number of elements expected to be treated and </span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        <span class="comment"># reset the ProgressionBar instance to follow the progression</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        ProgressionBar.get_instance().reset_instance( total = len( grouped_dsorf_all ) )</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;        </div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        <span class="keywordflow">for</span> grouped_dsorf <span class="keywordflow">in</span> grouped_dsorf_all:</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;        </div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;            <span class="comment"># Update and display the progression bar on the console</span></div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;            ProgressionBar.get_instance().increase_and_display()</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;            </div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;            objects_to_update = []</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;            </div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;            <span class="comment"># Parse the list to get the necessary attributes to instantiate an ORF object</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;            orf_chromosome = grouped_dsorf[ 0 ]</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;            orf_strand = grouped_dsorf[ 1 ]</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;            orf_start_pos = grouped_dsorf[ 2 ]</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;            orf_stop_pos = grouped_dsorf[ 3 ]</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;            orf_spliced = grouped_dsorf[ 4 ]</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;            orf_spliced_parts_count = grouped_dsorf[ 5 ]</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;            orf_splice_starts = grouped_dsorf[ 6 ]</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;            orf_splice_ends = grouped_dsorf[ 7 ]</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;            orf_related_dsorfs_ids = GeneralUtil.string_to_list( str_to_convert = grouped_dsorf[ 8 ], </div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                                                                 fct = <span class="stringliteral">&#39;int&#39;</span> )</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;            orf_related_datasources = GeneralUtil.string_to_list( str_to_convert = grouped_dsorf[ 9 ] )</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;            nb_of_dsorfs_grouped = grouped_dsorf[ 10 ]</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;            </div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;            <span class="comment"># If there is already an ORF looking like this one in the database, </span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;            <span class="comment"># then merge these two ORFs, i.e. create a new ORFDSAsso entry, </span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;            <span class="comment"># to keep record of the relationship with the corresponding ORF,</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;            <span class="comment"># and increase the count of ambiguous DSORFs associated to it of one.</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;            </div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;            <span class="comment"># Get the list of attributes which are not null for the current element </span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;            <span class="comment"># of the list (i.e. that do not equal None) and that should be use as </span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;            <span class="comment"># filter to query the ORF table</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;            attributes_to_use_for_filter = {}</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;            </div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;            <span class="keywordflow">for</span> att <span class="keywordflow">in</span> MergeStrategy.ATTRIBUTES_FOR_MERGING_SIMILAR_DSORF:</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                <span class="comment"># Get the value of the attribute</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                att_value = eval( <span class="stringliteral">&#39;orf_&#39;</span> + att )</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                <span class="comment"># Add the attribute as a filter to use only if it is not null</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                <span class="keywordflow">if</span> ( att_value != <span class="keywordtype">None</span> ):</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                    attributes_to_use_for_filter[ att ] = att_value</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;            </div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;            <span class="comment"># Query the PRO database to get the ORF(s) that look like the current entry</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;            existing_orf_query = SQLManagerPRO.get_instance().get_session().query( ORF )</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;            <span class="comment"># Sequentially apply the filters on the query</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;            <span class="keywordflow">for</span> ( att, value ) <span class="keywordflow">in</span> attributes_to_use_for_filter.items():</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                existing_orf_query = existing_orf_query.filter( eval( <span class="stringliteral">&#39;ORF.&#39;</span> + att ) == value )</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;            </div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            existing_orf = existing_orf_query.all()                                                                 </div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;            <span class="comment"># If there is at least one ORF returned, i.e. if there is at least one </span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;            <span class="comment"># ORF entry in the PRO database that may match the current element of the </span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;            <span class="comment"># list, then merge the DSORF(s) of the current element of the list with each </span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;            <span class="comment"># of these ORF entries. In other words, for each ORF that may match with the</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;            <span class="comment"># current DSORF(s), create a new ORFDSAsso entry, keep track of the relationship </span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;            <span class="comment"># to it and increase of one the count of ambiguous DSORFs associated to it.</span></div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;            <span class="comment"># Otherwise the DSORFs grouped together are not registered in the PRO database </span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;            <span class="comment"># (as too many essential information are missing to create a new entry).</span></div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;            <span class="keywordflow">if</span> ( len( existing_orf ) &gt; 0 ):</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                </div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                <span class="keywordflow">for</span> orf <span class="keywordflow">in</span> existing_orf:</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                </div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                    <span class="comment"># Increase the DS ambiguous count of one</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;                    orf.count_ds_ambiguous += 1</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;                    objects_to_update.append( orf )</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;                    </div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;                    <span class="comment"># Create the new ORFDSAsso</span></div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                    <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range( len( orf_related_dsorfs_ids ) ):</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;                        orfdsasso = ORFDSAsso( orf_id = orf.id,</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;                                               dsorf_id = orf_related_dsorfs_ids[ k ],</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                                               data_source = orf_related_datasources[ k ],</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                                               ambiguous = <span class="keyword">True</span> )</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                        objects_to_update.append( orfdsasso )</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;            </div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                <span class="comment"># Add the updated objects to the session (PRO database), and flush the session, </span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                <span class="comment"># so the query on the next step will return up-to-date results</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                SQLManagerPRO.get_instance().add_and_flush( objects_to_add = objects_to_update, </div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                                                            process = <span class="stringliteral">&#39;grouping similar ORFs&#39;</span> )</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        </div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;        <span class="comment"># Commit the changes and close the session</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;        SQLManagerPRO.get_instance().commit()</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        SQLManagerDS.get_instance().close_session()</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    </div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;    </div></div><!-- fragment -->
</div>
</div>
<a id="a69763877faecc4732eed2ab09cf32453"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a69763877faecc4732eed2ab09cf32453">&#9670;&nbsp;</a></span>merge_dsorftranscriptasso()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.merge_dsorftranscriptasso </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>merge_dsorftranscriptasso </h2>
<p>This method aims to process the entries of the DSORFTranscriptAsso table (DS database) to fill in the ORFTranscriptAsso table (PRO database). It first gets the list of all ( ORF, Transcript ) couples that exist and for each of them it gets the list of all DSORFTranscriptAsso corresponding to the couple. Then it merges the DSORFTranscriptAsso together in order to create one single entry associated with the couple in the ORFTranscriptAsso table (PRO database). </p>

<p>Reimplemented in <a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1ResumeMergeStrategy_1_1ResumeMergeStrategy.html#a694035b11661b57477bfe4dcf8e9b39b">fr.tagc.uorf.core.execution.ResumeMergeStrategy.ResumeMergeStrategy</a>.</p>
<div class="fragment"><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    <span class="keyword">def </span>merge_dsorftranscriptasso( self ):</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;        </div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Starting to merge the entries of the DSORFTranscriptAsso table.&#39;</span> )</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        </div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;        <span class="comment"># Get all the existing ( ORF, Transcript ) couples for which this </span></div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        <span class="comment"># is necessary to merge all the related DSORFTranscriptAsso</span></div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        self.get_dsorftranscriptasso_to_merge()</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        </div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        <span class="comment"># Merge the entries of the DSORFTranscriptAsso table        </span></div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        self.merge_dsota()</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        </div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;        </div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;    </div></div><!-- fragment -->
</div>
</div>
<a id="afdc08ae739263aa042c205f70e3bc040"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afdc08ae739263aa042c205f70e3bc040">&#9670;&nbsp;</a></span>merge_dsota()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.merge_dsota </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>merge_dsota </h2>
<p>This method allows to merge the entries of the DSORFTranscriptAsso table. NB: It needs the 'all_existing_orf_tr_asso_dict' dictionary stored into the DataManager in order to work properly. See the documentation of the <a class="el" href="classfr_1_1tagc_1_1uorf_1_1core_1_1execution_1_1MergeStrategy_1_1MergeStrategy.html#a8b12d5286400a811fc83c1f86c25e74d">get_dsorftranscriptasso_to_merge()</a> method for more information. </p>
<div class="fragment"><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;    <span class="keyword">def </span>merge_dsota( self ):</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;        </div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;        <span class="comment"># NB: This step is multi-processed</span></div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;        <span class="comment"># - As access of objects shared by the several processes (using locks and </span></div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;        <span class="comment">#   semaphores for instance), could slower a lot the speed of execution when the</span></div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;        <span class="comment">#   process regularly need to access these variables, it has been decided to do</span></div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;        <span class="comment">#   not access to shared resources. Then an object corresponding to a common entry </span></div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;        <span class="comment">#   (e.g. CellContextCatalog entry) may be instantiated by several processes at </span></div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;        <span class="comment">#   the same time. In order to respect the database integrity, several list of </span></div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;        <span class="comment">#   objects expected to be redundant are checked to discard this redundancy prior</span></div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;        <span class="comment">#   to perform to the insertion in the database.</span></div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;        <span class="comment"># - As forked processes require a copy of parent address space, they could be</span></div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;        <span class="comment">#   highly memory-consuming processes. In order to limit the number of elements</span></div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;        <span class="comment">#   stored in memory, the merging is performed by &quot;batch&quot; of pre-defined size.</span></div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        <span class="comment"># - As locks are not used, the progression bar displayed on the terminal is not</span></div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;        <span class="comment">#   instantaneously updated, but instead is updated at the end of each batch.</span></div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;        </div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;        <span class="comment"># Get all the existing ( ORF, Transcript ) associations </span></div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;        <span class="comment"># previously computed</span></div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;        all_existing_orf_tr_asso_dict = DataManager.get_instance().get_data( Constants.DM_ALL_EXISTING_ORF_TR_ASSO_DICT )</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;                </div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;        </div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;        </div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Starting to merge the DSORFTranscriptAsso entries&#39;</span> +</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;                                    <span class="stringliteral">&#39; for all existing ( ORF ID, Transcript ID ) couples.&#39;</span> )</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;        </div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;        <span class="comment"># Register all the new cell context, provided category </span></div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;        <span class="comment"># and FLOSS classification in dictionaries</span></div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;        DataManager.get_instance().store_PRO_query_result( Constants.DM_ALL_CELL_CTXT_CAT, </div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;                                                           <span class="stringliteral">&#39;query( CellContextCatalog ).all()&#39;</span> )</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;        DataManager.get_instance().store_PRO_query_result( Constants.DM_ALL_PROVIDED_CAT_CAT, </div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;                                                           <span class="stringliteral">&#39;query( ProvidedCategoryCatalog ).all()&#39;</span> )</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;        DataManager.get_instance().store_PRO_query_result( Constants.DM_ALL_FLOSS_CLASS_CAT, </div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;                                                           <span class="stringliteral">&#39;query( FLOSSClassCatalog ).all()&#39;</span> )</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;        </div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;        all_cell_ctxt_dict = DataManager.get_instance().get_data( Constants.DM_ALL_CELL_CTXT_CAT )</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;        all_provided_cat_dict = DataManager.get_instance().get_data( Constants.DM_ALL_PROVIDED_CAT_CAT )</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;        all_floss_dict = DataManager.get_instance().get_data( Constants.DM_ALL_FLOSS_CLASS_CAT )</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;        </div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;        </div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;        <span class="comment"># Get the number total number of elements expected to be treated and </span></div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;        <span class="comment"># reset the ProgressionBar instance to follow the progression</span></div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;        ProgressionBar.get_instance().reset_instance( total = len( all_existing_orf_tr_asso_dict.keys() ) )</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;        ProgressionBar.get_instance().display()</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;        </div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;        </div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;        <span class="comment"># During the merging of the DSORFTranscriptAsso entries, a consensus of the</span></div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;        <span class="comment"># amino acid and nucleic sequences needs to be computed. As this step uses</span></div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;        <span class="comment"># MUSCLE, it needs to write the sequences and alignment in a fasta file. </span></div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;        <span class="comment"># Hence, the fasta files are saved in a temporary folder. In order to avoid </span></div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;        <span class="comment"># any conflict related to the creation of the directory by the first parallel </span></div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;        <span class="comment"># processes at the same time, this folder is created prior to run the processes.</span></div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;        <span class="keywordflow">if</span> ( <span class="keywordflow">not</span> os.path.exists( DefaultTemporaryFolder.TEMPORARY_FOLDER ) ):</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;            os.makedirs( DefaultTemporaryFolder.TEMPORARY_FOLDER )</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;            </div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;        <span class="comment"># Instantiate the list of tuple-embedded arguments necessary </span></div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;        <span class="comment"># to create the new PRO entries </span></div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;        <span class="comment"># As the same DSORFTranscriptAsso may be merged into several </span></div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;        <span class="comment"># ORFTranscriptAsso, the ID is build by incrementing a counter.</span></div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;        args_for_merging_list = []</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;        </div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;        <span class="comment"># If there is any entry existing in the ORFTranscriptAsso table, </span></div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;        <span class="comment"># get the value of the highest ID</span></div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;        ota_count = SQLManagerPRO.get_instance().get_session().query( ORFTranscriptAsso ).count()</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;        <span class="keywordflow">if</span> ( ota_count != 0 ):</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;            max_ota_id = SQLManagerPRO.get_instance().get_session().query( func.max( ORFTranscriptAsso.id ) ).one()[0]</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;            ota_id = max_ota_id + 1</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;            ota_id = 1</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;        </div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;        <span class="keywordflow">for</span> ( orf_tr_asso, dsorftranscriptasso_list ) <span class="keywordflow">in</span> all_existing_orf_tr_asso_dict.items():</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;            <span class="comment"># Append to the list the tuple required by the MergeDSOTA.merge_dsota() method</span></div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;            <span class="comment"># (see the documentation of this method for more information)</span></div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;            args_for_merging_list.append( ( ota_id,</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;                                            orf_tr_asso, </div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;                                            dsorftranscriptasso_list,</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;                                            self.check_dsota_coherence,</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;                                            self.compute_consensus,</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;                                            self.sqce_consensus_ambig_threshold,</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;                                            self.max_len_diff_dsota_clust ) )</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;            ota_id += 1</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;        </div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;        </div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;        <span class="comment"># Split the list into sublists of defined sizes, such as processes</span></div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;        <span class="comment"># are run by sequential &quot;batches&quot; of pools</span></div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;        args_for_merging_sublists = [ args_for_merging_list[ min_bound : min_bound + </div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;                                                             Constants.MAX_POOL_SIZE ] \</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;                                      <span class="keywordflow">for</span> min_bound <span class="keywordflow">in</span> xrange( 0, </div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;                                                               len( args_for_merging_list ), </div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;                                                               Constants.MAX_POOL_SIZE ) ]</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;        </div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;        <span class="comment"># Instantiate the pool</span></div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;        p = Pool( self.thread_nb )</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;            </div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;        <span class="comment"># Sequentially process these &quot;batches&quot;</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;        <span class="keywordflow">for</span> args_for_merging_sublist <span class="keywordflow">in</span> args_for_merging_sublists:</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;            </div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;            Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dsota(): &#39;</span> + str( len( args_for_merging_sublist ) ) +</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;                                         <span class="stringliteral">&#39; subprocess will be started to perform the merging of the&#39;</span> +</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;                                         <span class="stringliteral">&#39; DSORFTranscriptAsso entries.&#39;</span> )</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;            </div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;            <span class="comment"># Instantiate the list of new objects to be added</span></div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;            <span class="comment"># to the database</span></div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;            objects_to_insert = []</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;                    </div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;            <span class="comment"># For each group of DSORFTranscriptAsso to merge, run the MergeDSOTA.merge_dsota() </span></div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;            <span class="comment"># static method that will instantiate all the appropriate objects to insert in the </span></div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;            <span class="comment"># PRO database</span></div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;            m = MergeDSOTA()</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;            all_objects_to_insert = p.map( m.merge_dsota, args_for_merging_sublist )</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;            p.close()</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;            <span class="comment"># Wait for all processes to be completed</span></div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;            p.join()</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;            </div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;        </div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;            <span class="comment"># Get the new objects to add to the session</span></div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;            <span class="keywordflow">for</span> obj_to_insert_sublist <span class="keywordflow">in</span> all_objects_to_insert:</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;                </div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;                <span class="comment"># Parse the output of the MergeDSOTA.merge_dsota() method</span></div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;                ( new_objects, </div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;                  cell_ctxt_catalog_to_insert, </div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;                  provided_cat_catalog_to_insert, </div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;                  floss_class_catelog_to_insert, </div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;                  error_messages_to_log, </div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;                  warning_messages_to_log ) = obj_to_insert_sublist</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;                </div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;                <span class="comment"># For each of the CellContextCatalog, ProvidedCategoryCatalog and </span></div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;                <span class="comment"># FlossClassCatalog instances, only add them to the list of objects</span></div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;                <span class="comment"># to insert if if they are not yet existing in the database and if</span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;                <span class="comment"># they have not already been added to the session.</span></div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;                <span class="keywordflow">for</span> new_cell_ctxt <span class="keywordflow">in</span> cell_ctxt_catalog_to_insert:</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;                    <span class="keywordflow">if</span> ( <span class="keywordflow">not</span> all_cell_ctxt_dict.get( new_cell_ctxt ) ):</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;                        all_cell_ctxt_dict[ new_cell_ctxt ] = new_cell_ctxt</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;                        objects_to_insert.append( new_cell_ctxt )</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;                </div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;                <span class="keywordflow">for</span> new_provided_cat <span class="keywordflow">in</span> provided_cat_catalog_to_insert:</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;                    <span class="keywordflow">if</span> ( <span class="keywordflow">not</span> all_provided_cat_dict.get( new_provided_cat ) ):</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;                        all_provided_cat_dict[ new_provided_cat ] = new_provided_cat</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;                        objects_to_insert.append( new_provided_cat )</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;                </div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;                <span class="keywordflow">for</span> new_floss <span class="keywordflow">in</span> floss_class_catelog_to_insert:</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;                    <span class="keywordflow">if</span> ( <span class="keywordflow">not</span> all_floss_dict.get( new_floss ) ):</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;                        all_floss_dict[ new_floss ] = new_floss</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;                        objects_to_insert.append( new_floss )</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;                </div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;                <span class="comment"># NB: The new entries are the last to be added to the list of objects</span></div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;                <span class="comment">#     to add to the session, as parent entries that required to be </span></div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;                <span class="comment">#     existing could have been instantiated by the function (and thus </span></div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;                <span class="comment">#     added to one of the previous lists).</span></div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;                objects_to_insert += new_objects</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;                    </div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;                <span class="comment"># Log the messages instantiated during the execution </span></div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;                <span class="comment"># of the MergeDSOTA.merge_dsota() method</span></div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;                <span class="keywordflow">for</span> warning_message <span class="keywordflow">in</span> warning_messages_to_log:</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;                    Logger.get_instance().warning( warning_message )</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;                    </div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;                <span class="keywordflow">for</span> error_message <span class="keywordflow">in</span> error_messages_to_log:</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;                    Logger.get_instance().error( error_message, ex = <span class="keywordtype">None</span>)</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;                    </div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;            <span class="comment"># Display the progression on the terminal</span></div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;            ProgressionBar.get_instance().increase_and_display( add_val = Constants.MAX_POOL_SIZE )</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;            </div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;            <span class="comment"># Insert the new objects in the PRO database and commit the changes</span></div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;            self.batch_insert_to_PRO_db( objects_to_insert = objects_to_insert,</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;                                         filename = <span class="stringliteral">&#39;orftranscriptasso&#39;</span>,</div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;                                         process = <span class="stringliteral">&#39;grouping DSORFTranscriptAsso entries&#39;</span> )</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;            SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;            </div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;            <span class="comment"># Restart the pool</span></div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;            p.restart()</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;            </div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;        <span class="comment"># Delete the pool instance</span></div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        p.clear()</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;                    </div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;                    </div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;    </div></div><!-- fragment -->
</div>
</div>
<a id="a6bd4005b55af502f76009505ae736193"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6bd4005b55af502f76009505ae736193">&#9670;&nbsp;</a></span>merge_dstranscripts()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.merge_dstranscripts </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>merge_dstranscripts </h2>
<p>This methods aims to merge the similar entries of the DSTranscript table (DS database) into new entries of the Transcript table (PRO database). </p>
<div class="fragment"><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="keyword">def </span>merge_dstranscripts( self ):</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;        </div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Starting to merge the entries of the DSTranscript table.&#39;</span>)</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        </div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        objects_to_insert = []</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;            </div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        </div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;        </div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;        <span class="comment"># First, </span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;        <span class="comment"># - Get the list of DSTranscripts regrouped by transcripts sharing the same ID</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;        <span class="comment">#   and such as the transcript does not start with the &quot;UNKNOWN_TRANSCRIPT_&quot; prefix </span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        <span class="comment">#   (i.e. the transcript is not a &quot;fake&quot; transcript).</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        <span class="comment">#   NB: This only happens when an official ID (e.g. NCBI or Ensembl transcript ID) </span></div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        <span class="comment">#       has been provided by the data source.</span></div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;        <span class="comment"># - For each entry of the list (i.e. grouped DSTranscript entries), create a new</span></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;        <span class="comment">#   Transcript entry in the PRO database.</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        <span class="comment">#</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Starting to regroup the entries of the DSTranscript table&#39;</span> +</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                                    <span class="stringliteral">&#39; (DS database) with the same official ID into new Transcript&#39;</span> +</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                                    <span class="stringliteral">&#39; entries (PRO database).&#39;</span> )</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        </div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dstranscripts(): Querying the DS database&#39;</span> +</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                                     <span class="stringliteral">&#39; to regroup the transcripts with same official ID together.&#39;</span>)</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        grouped_dstranscripts_by_ids_all = SQLManagerDS.get_instance().get_session().query(</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;                                                                                            DSTranscript.transcript_id,</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;                                                                                            DSTranscript.gene_id,</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;                                                                                            func.group_concat( DSTranscript.strand ),</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                                                                                            func.group_concat( DSTranscript.start_pos ),</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                                                                                            func.group_concat( DSTranscript.end_pos ),</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                                                                                            func.group_concat( DSTranscript.cds_start_pos ),</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;                                                                                            func.group_concat( DSTranscript.cds_stop_pos ),</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                                                                                            func.group_concat( DSTranscript.rna_biotype ),</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                                                                                            func.group_concat( DSTranscript.id ),</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;                                                                                            func.group_concat( DSTranscript.data_source ),</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;                                                                                            func.count( DSTranscript.id )</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;                                                                                        ).filter(</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;                                                                                                    DSTranscript.transcript_id.notlike( Constants.PREFIX_FAKE_TRANSCRIPT + <span class="stringliteral">&#39;%&#39;</span> )</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;                                                                                                ).group_by(</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;                                                                                                            DSTranscript.transcript_id,</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                                                                                                            DSTranscript.gene_id</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;                                                                                                            ).order_by(</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;                                                                                                                        DSTranscript.transcript_id.desc()</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;                                                                                                                        ).all()</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;                                                                                                        </div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        <span class="comment"># For each unique component of this list (i.e. each merged element, i.e. each </span></div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        <span class="comment"># transcript identified as unique), create a new Transcript in the PRO database</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dstranscripts(): Regrouping the&#39;</span> +</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;                                     <span class="stringliteral">&#39; entries of the DSTranscript table (DS database) with&#39;</span> +</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;                                     <span class="stringliteral">&#39; the same official IDs into new Transcript entries (PRO database).&#39;</span> )</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;        </div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        <span class="comment"># Get the number total number of elements expected to be treated and </span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        <span class="comment"># reset the ProgressionBar instance to follow the progression</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        ProgressionBar.get_instance().reset_instance( total = len( grouped_dstranscripts_by_ids_all ) )</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        </div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        <span class="keywordflow">if</span> ( len( grouped_dstranscripts_by_ids_all ) != 0 ):</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;            previous_transcript_id = grouped_dstranscripts_by_ids_all[ 0 ][ 0 ]</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;            all_gene_ids_for_transcript = [ grouped_dstranscripts_by_ids_all[ 0 ][ 1 ] ]</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        </div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        <span class="keywordflow">for</span> grouped_dstranscripts_by_ids <span class="keywordflow">in</span> grouped_dstranscripts_by_ids_all:</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;            </div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;            <span class="comment"># Update and display the progression bar on the console</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;            ProgressionBar.get_instance().increase_and_display()</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                        </div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;            <span class="comment"># Parse the list into a dictionary to get the necessary </span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;            <span class="comment"># attributes to instantiate a Transcript object</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;            transcript_val = {</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                                <span class="stringliteral">&#39;transcript_id&#39;</span>: grouped_dstranscripts_by_ids[ 0 ],</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                                <span class="stringliteral">&#39;gene_id&#39;</span>: grouped_dstranscripts_by_ids[ 1 ],</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;                                <span class="stringliteral">&#39;strand&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_ids[ 2 ] ),</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                                <span class="stringliteral">&#39;start_pos&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_ids[ 3 ], fct = <span class="stringliteral">&#39;int&#39;</span> ),</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                                <span class="stringliteral">&#39;end_pos&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_ids[ 4 ], fct = <span class="stringliteral">&#39;int&#39;</span> ),</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                                <span class="stringliteral">&#39;cds_start_pos&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_ids[ 5 ], fct = <span class="stringliteral">&#39;int&#39;</span> ),</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                                <span class="stringliteral">&#39;cds_stop_pos&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_ids[ 6 ], fct = <span class="stringliteral">&#39;int&#39;</span> ),</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                                <span class="stringliteral">&#39;rna_biotype&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_ids[ 7 ] ) ,</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                                <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_ids[ 8 ], fct = <span class="stringliteral">&#39;int&#39;</span> ),</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                                <span class="stringliteral">&#39;related_datasources&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_ids[ 9 ] ),</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                                <span class="stringliteral">&#39;nb_of_dstranscripts_grouped&#39;</span>: grouped_dstranscripts_by_ids[ 10 ]</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;                              }</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;            </div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;            <span class="comment"># The lowest transcript ID of all DSTranscripts regrouped will be used </span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;            <span class="comment"># as unique ID of the new Transcript object</span></div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;            transcript_id = min( transcript_val.get( <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span> ) )</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;            </div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;            <span class="comment"># If there are attributes that are provided (i.e. different to None) and do not agree with each other, set them to None</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;            <span class="keywordflow">for</span> att <span class="keywordflow">in</span> MergeStrategy.ATT_TO_CHECK_FOR_MERGING_SAME_DSTRANSCRIPT:</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                </div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                att_value = transcript_val.get( att )</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                <span class="keywordflow">if</span> ( att_value != <span class="keywordtype">None</span> ):</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                    </div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                    <span class="comment"># Remove any ambiguous flag from the list of values</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                    att_value = [ v <span class="keywordflow">for</span> v <span class="keywordflow">in</span> att_value <span class="keywordflow">if</span> ( v != Constants.DENCELLORFOBJ_AMBIGUOUS_ATT ) ]</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;                    </div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                    <span class="comment"># If there is one single element different from None, </span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                    <span class="comment"># use this value to instantiate the new Transcript</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                    <span class="keywordflow">if</span> ( len( att_value ) == 1 ):</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                        transcript_val[ att ] = att_value[ 0 ]</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                        </div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                    <span class="comment"># Otherwise, look if all provided elements are equals. </span></div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                    <span class="comment"># If not, set the value of the new Transcript attribute to None </span></div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;                    <span class="comment"># and log a warning.</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                        <span class="keywordflow">if</span> all( ( ( e == <span class="keywordtype">None</span> ) <span class="keywordflow">or</span> ( ( e != <span class="keywordtype">None</span> ) <span class="keywordflow">and</span> ( e == att_value[ 0 ] ) ) ) <span class="keywordflow">for</span> e <span class="keywordflow">in</span> att_value ):</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                           transcript_val[ att ] = att_value[ 0 ]</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                           </div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                            transcript_val[ att ] = <span class="keywordtype">None</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                            Logger.get_instance().warning( <span class="stringliteral">&#39;Several values have been found for the&#39;</span> +</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;                                                           <span class="stringliteral">&#39; attribute &#39;</span> + str( att ) + <span class="stringliteral">&#39; whilst creating&#39;</span> +</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                                                           <span class="stringliteral">&#39; the Transcript with ID &quot;&#39;</span> + str( transcript_id ) + </div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                                                           <span class="stringliteral">&#39;&quot; by merging the DSTranscript with IDs &quot;&#39;</span> + </div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;                                                            <span class="stringliteral">&#39;, &#39;</span>.join( transcript_val[ <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span> ] ) + </div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;                                                            <span class="stringliteral">&#39;&quot; (&#39;</span> + str( [ e <span class="keywordflow">for</span> e <span class="keywordflow">in</span> att_value <span class="keywordflow">if</span> ( e != <span class="keywordtype">None</span> ) ] ) + <span class="stringliteral">&#39;).&#39;</span> +</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                                                            <span class="stringliteral">&#39; Hence the value of this attribute has been set to None.&#39;</span> +</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                                                            <span class="stringliteral">&#39; Warning code: &#39;</span> + LogCodes.WARN_MERG_CONFL_TR + <span class="stringliteral">&#39;.&#39;</span> )</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            </div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;            <span class="comment"># Instantiate the new transcript</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;            transcript = Transcript( id = transcript_id,</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;                                     transcript_id = transcript_val.get( <span class="stringliteral">&#39;transcript_id&#39;</span> ),</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                                     gene_id = transcript_val.get( <span class="stringliteral">&#39;gene_id&#39;</span> ),</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                                     strand = transcript_val.get( <span class="stringliteral">&#39;strand&#39;</span> ),</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                                     start_pos = transcript_val.get( <span class="stringliteral">&#39;start_pos&#39;</span> ),</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                                     end_pos = transcript_val.get( <span class="stringliteral">&#39;end_pos&#39;</span> ),</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;                                     cds_start_pos = transcript_val.get( <span class="stringliteral">&#39;cds_start_pos&#39;</span> ),</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;                                     cds_stop_pos = transcript_val.get( <span class="stringliteral">&#39;cds_stop_pos&#39;</span> ),</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;                                     rna_biotype = transcript_val.get( <span class="stringliteral">&#39;rna_biotype&#39;</span> ),</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                                     count_ds = transcript_val.get( <span class="stringliteral">&#39;nb_of_dstranscripts_grouped&#39;</span> ),</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                                     count_ds_ambiguous = 0 )</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;            objects_to_insert.append( transcript )</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;            </div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;            <span class="comment"># Register in the TranscriptDSAsso the relationship between this Transcript</span></div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;            <span class="comment"># and the DSTranscript entries from which it has been created</span></div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;            <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range( len( transcript_val[ <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span> ] ) ):</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;                </div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;                transcrtipdsasso = TranscriptDSAsso( transcript_id = transcript.id,</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                                                     dstranscript_id = transcript_val.get( <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span> )[ k ],</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;                                                     data_source = transcript_val.get( <span class="stringliteral">&#39;related_datasources&#39;</span> )[ k ],</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                                                     ambiguous = <span class="keyword">False</span> )</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                objects_to_insert.append( transcrtipdsasso )</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;                                        </div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;            </div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;            <span class="comment"># If the same transcript ID is found associated with several Gene IDs, log a warning </span></div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;            <span class="keywordflow">if</span> ( transcript_val.get( <span class="stringliteral">&#39;transcript_id&#39;</span> ) != previous_transcript_id ):</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                </div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                <span class="comment"># If the previous transcript ID was associated wit several gene IDs, log a warning </span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                <span class="keywordflow">if</span> ( len( all_gene_ids_for_transcript ) != 1 ):</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                    Logger.get_instance().warning( <span class="stringliteral">&#39;The official transcript ID &quot;&#39;</span> + </div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                                                   str( previous_transcript_id ) +</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;                                                   <span class="stringliteral">&#39;&quot; has been found associated with several genes: &quot;&#39;</span> + </div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;                                                   <span class="stringliteral">&#39;, &#39;</span>.join( all_gene_ids_for_transcript ) + </div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                                                   <span class="stringliteral">&#39;&quot;. Hence, several distinct entries will be created in&#39;</span> +</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;                                                   <span class="stringliteral">&#39; the Transcripts table (PRO database).&#39;</span> +</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;                                                   <span class="stringliteral">&#39; Warning code: &#39;</span> + LogCodes.WARN_MERG_CONFL_GENE_ASSO_TR + <span class="stringliteral">&#39;.&#39;</span> )</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;                </div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;                <span class="comment"># Keep the record of all the genes associated with this transcript id</span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;                all_gene_ids_for_transcript = [ transcript_val.get( <span class="stringliteral">&#39;gene_id&#39;</span> ) ]</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;                </div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;                <span class="comment"># Store the value of this new transcript ID</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;                previous_transcript_id = transcript_val.get( <span class="stringliteral">&#39;transcript_id&#39;</span> )</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;                </div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;                <span class="comment"># Keep record of any new gene ID associated with this transcript</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;                <span class="keywordflow">if</span> ( transcript_val.get( <span class="stringliteral">&#39;gene_id&#39;</span> ) <span class="keywordflow">not</span> <span class="keywordflow">in</span> all_gene_ids_for_transcript ):</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;                    all_gene_ids_for_transcript.append( transcript_val.get( <span class="stringliteral">&#39;gene_id&#39;</span> ) )</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;        </div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;        </div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        <span class="comment"># Insert the newly created objects in the database</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;        self.batch_insert_to_PRO_db( objects_to_insert = objects_to_insert, </div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;                                     filename = <span class="stringliteral">&#39;transcripts_with_same_off_id&#39;</span>,</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                                     process = <span class="stringliteral">&#39;grouping transcripts with same official ID&#39;</span> )</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;        SQLManagerDS.get_instance().close_session()</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        </div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;        </div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;        </div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        objects_to_insert = []</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        </div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        </div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;        </div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        <span class="comment"># Then, </span></div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        <span class="comment"># - Group all the DSTranscripts that have not already been processed </span></div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        <span class="comment">#   (i.e. all the transcript having the &quot;UNKNOWN_TRANSCRIPT_&quot; prefix) </span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        <span class="comment">#   together by related gene ID.</span></div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;        <span class="comment"># - When the information about the transcript start and end is provided, </span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        <span class="comment">#   try to see if the transcript can be merged with one of the previously </span></div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        <span class="comment">#   created Transcript. If this is not possible or if the start and end are</span></div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;        <span class="comment">#   missing, create a new Transcript entry with ID [ &quot;UNKNOWN_&quot; + gene_id ].</span></div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        <span class="comment">#</span></div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        Logger.get_instance().info( <span class="stringliteral">&#39;Starting to regroup the entries of the DSTranscript table&#39;</span> +</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                                    <span class="stringliteral">&#39; (DS database) with the same &quot;unknown&quot; ID into new Transcript&#39;</span> +</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                                    <span class="stringliteral">&#39; entries (PRO database).&#39;</span> )</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        </div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dstranscripts(): Querying the DS database&#39;</span> +</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;                                     <span class="stringliteral">&#39; to regroup the same &quot;unknown&quot; transcripts together.&#39;</span>)</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;        </div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        grouped_dstranscripts_by_gene_all = SQLManagerDS.get_instance().get_session().query(</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;                                                                                                DSTranscript.gene_id,</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;                                                                                                DSTranscript.strand,</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;                                                                                                DSTranscript.start_pos,</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;                                                                                                DSTranscript.end_pos,</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;                                                                                                DSTranscript.cds_start_pos,</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;                                                                                                DSTranscript.cds_stop_pos,</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;                                                                                                func.group_concat( DSTranscript.rna_biotype ),</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;                                                                                                func.group_concat( DSTranscript.transcript_id ),</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;                                                                                                func.group_concat( DSTranscript.id ),</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;                                                                                                func.group_concat( DSTranscript.data_source ),</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;                                                                                                func.count( DSTranscript.id )</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;                                                                                            ).filter(</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;                                                                                                        DSTranscript.transcript_id.like( Constants.PREFIX_FAKE_TRANSCRIPT + <span class="stringliteral">&#39;%&#39;</span> )</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;                                                                                                    ).group_by(</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;                                                                                                                DSTranscript.gene_id,</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;                                                                                                                DSTranscript.strand,</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;                                                                                                                DSTranscript.start_pos,</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;                                                                                                                DSTranscript.end_pos,</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;                                                                                                                DSTranscript.cds_start_pos,</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;                                                                                                                DSTranscript.cds_stop_pos,</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;                                                                                                               ).all()</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        </div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;        <span class="comment"># For each unique component of the list (i.e. each merged element), check if there is a Transcript</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;        <span class="comment"># sharing the same gene ID, start and stop positions in the PRO database</span></div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;        Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.merge_dstranscripts(): Regrouping the&#39;</span> +</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;                                     <span class="stringliteral">&#39; entries of the DSTranscript table (DS database) with&#39;</span> +</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;                                     <span class="stringliteral">&#39; the &quot;unknown&quot; IDs into new Transcript entries (PRO database).&#39;</span> )</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        </div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        <span class="comment"># Get the number total number of elements expected to be treated and </span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        <span class="comment"># reset the ProgressionBar instance to follow the progression</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        ProgressionBar.get_instance().reset_instance( total = len( grouped_dstranscripts_by_gene_all ) )</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;        </div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        <span class="keywordflow">for</span> grouped_dstranscripts_by_gene <span class="keywordflow">in</span> grouped_dstranscripts_by_gene_all:</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;            </div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;            <span class="comment"># Update and display the progression bar on the console</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;            ProgressionBar.get_instance().increase_and_display()</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;            </div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;            objects_to_insert = []</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;            </div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;            <span class="comment"># Parse the list into a dictionary to get the necessary attributes </span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;            <span class="comment"># to search for or instantiate a Transcript object</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;            transcript_val = {</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;                                <span class="stringliteral">&#39;gene_id&#39;</span>: grouped_dstranscripts_by_gene[ 0 ],</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                                <span class="stringliteral">&#39;strand&#39;</span>: grouped_dstranscripts_by_gene[ 1 ],</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                                <span class="stringliteral">&#39;start_pos&#39;</span>: grouped_dstranscripts_by_gene[ 2 ],</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;                                <span class="stringliteral">&#39;end_pos&#39;</span>: grouped_dstranscripts_by_gene[ 3 ],</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;                                <span class="stringliteral">&#39;cds_start_pos&#39;</span>: grouped_dstranscripts_by_gene[ 4 ],</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;                                <span class="stringliteral">&#39;cds_stop_pos&#39;</span>: grouped_dstranscripts_by_gene[ 5 ],</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;                                <span class="stringliteral">&#39;rna_biotype&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_ids[ 6 ] ) ,</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;                                <span class="stringliteral">&#39;related_dstranscript_tr_ids&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_gene[ 7 ] ),</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;                                <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_gene[ 8 ], fct = <span class="stringliteral">&#39;int&#39;</span> ),</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;                                <span class="stringliteral">&#39;related_datasources&#39;</span>: GeneralUtil.string_to_list( str_to_convert = grouped_dstranscripts_by_gene[ 9 ] ),</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;                                <span class="stringliteral">&#39;nb_of_dstranscripts_grouped&#39;</span>: grouped_dstranscripts_by_gene[ 10 ]</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;                              }</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;            </div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;            </div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;            <span class="comment"># If there is already an Transcript entry looking like this one in the database, </span></div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;            <span class="comment"># then merge these two Transcripts, i.e. create a new TranscriptDSAsso entry to </span></div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;            <span class="comment"># keep record of the relationship with the corresponding Transcript,</span></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;            <span class="comment"># and increase of one the count of ambiguous Transcripts associated to it.</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;            </div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;            <span class="comment"># Query the Transcript table for entries that have the same gene ID</span></div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;            existing_transcript_query_on_gene = SQLManagerPRO.get_instance().get_session().query( Transcript ).filter( </div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;                                                                                                                        Transcript.gene_id == transcript_val.get( <span class="stringliteral">&#39;gene_id&#39;</span> )</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;                                                                                                                      )</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;            </div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;            </div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;            <span class="comment"># Get the list of attributes which are not null for the current element </span></div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;            <span class="comment"># of the list (i.e. that do not equal None) and that should be use as </span></div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;            <span class="comment"># filter to query the Transcript table</span></div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;            attributes_to_use_for_filter = {}</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;            </div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;            <span class="keywordflow">for</span> att <span class="keywordflow">in</span> MergeStrategy.ATTRIBUTES_FOR_MERGING_SIMILAR_DSTRANSCRIPT:</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;                <span class="comment"># Get the value of the attribute</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;                att_value = transcript_val.get( att )</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;                <span class="comment"># Add the attribute as a filter to use only if it is not null</span></div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;                <span class="keywordflow">if</span> ( att_value != <span class="keywordtype">None</span> ):</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;                    attributes_to_use_for_filter[ att ] = att_value</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;                    </div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;            <span class="comment"># Query the PRO database to get the Transcript entrie(s)</span></div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;            <span class="comment"># that look like the current entry</span></div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;            existing_transcript_query_on_all = existing_transcript_query_on_gene</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;            <span class="comment"># Sequentially apply the filter on the query</span></div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;            <span class="keywordflow">for</span> ( att, value ) <span class="keywordflow">in</span> attributes_to_use_for_filter.items():</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                existing_transcript_query_on_all = existing_transcript_query_on_all.filter( eval( <span class="stringliteral">&#39;DSTranscript.&#39;</span> + att ) == value )</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;            </div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;            existing_transcript = existing_transcript_query_on_all.all()</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;            </div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;            <span class="comment"># If there is at least one Transcript returned, i.e. if there is at </span></div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;            <span class="comment"># least one Transcript in the PRO database that may match the current </span></div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;            <span class="comment"># element of the list, and such as the two transcript share at least </span></div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;            <span class="comment"># two characteristics (strand, start, end, CDS start and stop positions), </span></div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;            <span class="comment"># then merge the DSTranscript(s) of the current element of the list with </span></div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;            <span class="comment"># each of these Transcript entries. In other words, for each Transcript </span></div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;            <span class="comment"># entry that may match with the current DSDSTranscript(s), create a new </span></div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;            <span class="comment"># TranscriptDSAsso entry, keep the relationship with it and increase of </span></div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;            <span class="comment"># one the count of ambiguous DSDSTranscripts associated to it. </span></div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;            <span class="keywordflow">if</span> ( ( len( attributes_to_use_for_filter.keys() ) &gt; 1 )</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;                 <span class="keywordflow">and</span> ( len( existing_transcript ) &gt; 1 ) ):</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;                </div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;                <span class="keywordflow">for</span> transcript <span class="keywordflow">in</span> existing_transcript:</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;                    </div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;                    <span class="comment"># Increase the non-ambiguous count of one</span></div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;                    transcript.count_ds_ambiguous += 1</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;                </div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;                    <span class="comment"># Create the new TranscriptDSAsso</span></div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;                    <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range( len( transcript_val.get( <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span> ) ) ):</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;                        transcriptdsasso = TranscriptDSAsso( transcript_id = transcript.id,</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;                                                             dstranscript_id = transcript_val.get( <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span> )[ k ],</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;                                                             data_source = transcript_val.get( <span class="stringliteral">&#39;related_datasources&#39;</span> )[ k ],</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;                                                             ambiguous = <span class="keyword">True</span> )</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;                        objects_to_insert.append( transcriptdsasso )</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;                        </div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;                    objects_to_insert.append( transcript )</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        </div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;            <span class="comment"># Otherwise create a new Transcript</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;                </div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;                transcript_id = min( transcript_val.get( <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span> ) )</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;                </div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;                <span class="comment"># Create the new Transcript</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                transcript = Transcript( id = transcript_id,</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;                                         transcript_id = Constants.UNKNOWN_TRANSCRIPT,</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;                                         gene_id = transcript_val.get( <span class="stringliteral">&#39;gene_id&#39;</span> ),</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;                                         strand = transcript_val.get( <span class="stringliteral">&#39;strand&#39;</span> ),</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;                                         start_pos = transcript_val.get( <span class="stringliteral">&#39;start_pos&#39;</span> ),</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;                                         end_pos = transcript_val.get( <span class="stringliteral">&#39;end_pos&#39;</span> ),</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;                                         cds_start_pos = transcript_val.get( <span class="stringliteral">&#39;cds_start_pos&#39;</span> ),</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;                                         cds_stop_pos = transcript_val.get( <span class="stringliteral">&#39;cds_stop_pos&#39;</span> ),</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;                                         rna_biotype = transcript_val.get( <span class="stringliteral">&#39;rna_biotype&#39;</span> ),</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;                                         count_ds = 0,</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;                                         count_ds_ambiguous = transcript_val.get( <span class="stringliteral">&#39;nb_of_dstranscripts_grouped&#39;</span> ) )</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                </div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;                <span class="comment"># Create the new TranscriptDSAsso</span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;                <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range( len( transcript_val.get( <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span> ) ) ):</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;                    transcriptdsasso = TranscriptDSAsso( transcript_id = transcript.id,</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;                                                         dstranscript_id = transcript_val.get( <span class="stringliteral">&#39;related_dstranscript_ids&#39;</span> )[ k ],</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;                                                         data_source = transcript_val.get( <span class="stringliteral">&#39;related_datasources&#39;</span> )[ k ],</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;                                                         ambiguous = <span class="keyword">True</span> )</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;                    objects_to_insert.append( transcriptdsasso )</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;                    </div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;                objects_to_insert.append( transcript )</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;            <span class="comment"># Add the new objects to the session (PRO database), and flush the session</span></div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;            <span class="comment"># so the query on the next step will return up-to-date results</span></div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;            SQLManagerPRO.get_instance().add_and_flush( objects_to_add = objects_to_insert, </div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;                                                        process = <span class="stringliteral">&#39;grouping transcripts with same &quot;unknown&quot; ID&#39;</span> )</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;        </div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;        <span class="comment"># Commit the changes and close the session</span></div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;        SQLManagerPRO.get_instance().commit()</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;        SQLManagerPRO.get_instance().close_session()</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;        SQLManagerDS.get_instance().close_session()</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;    </div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    </div></div><!-- fragment -->
</div>
</div>
<a id="a999869c415f278d64898cfc966900530"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a999869c415f278d64898cfc966900530">&#9670;&nbsp;</a></span>parse_config()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.parse_config </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>parse_config </h2>
<p>Parse the config file to retrieve required information.</p>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">DenCellORFException</td><td>When expected sections / options are not provided in the config file. </td></tr>
    <tr><td class="paramname">DenCellORFException</td><td>When the threshold to use as value for the minimal absolute difference in genomic lengths at which the DSORF entries should not be considered to build the PRO database cannot be converted into an interger or is a negative value different to -1. </td></tr>
    <tr><td class="paramname">DenCellORFException</td><td>When the threshold to use to compute the sequence consensus cannot be converted into a float or is outside of the [0,1] interval. </td></tr>
    <tr><td class="paramname">DenCellORFException</td><td>When the value of the maximal difference between the max. and min. lengths of DSORFTranscriptAsso entries to belong to the same "cluster" cannot be converted into an integer or is negative. </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="keyword">def </span>parse_config( self ):</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        </div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="comment"># Read the configfile</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        config = ConfigParser.ConfigParser()</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        config.optionxform = <span class="keyword">lambda</span> option: option</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        config.read( self.configfile )</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        </div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="comment"># Get the value of the minimal absolute difference in genomic </span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="comment"># lengths at which the DSORF entries should not be considered </span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="comment"># to build the PRO database</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keywordflow">if</span> config.has_option( Constants.CONFIG_SECTION_MERGE_PARAMETERS, Constants.CONFIG_SECTION_MERGE_PARAMETERS_ITEM_GEN_LEN_DIFF_THRESHOLD ):</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            self.gen_len_diff_threshold = config.get( Constants.CONFIG_SECTION_MERGE_PARAMETERS, </div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                                                      Constants.CONFIG_SECTION_MERGE_PARAMETERS_ITEM_GEN_LEN_DIFF_THRESHOLD )</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                self.gen_len_diff_threshold = int( self.gen_len_diff_threshold )</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;            <span class="keywordflow">except</span>:</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;MergeStrategy.parse_config(): The threshold to used as minimal&#39;</span> +</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                                           <span class="stringliteral">&#39; value for the absolute difference in genomic lengths at which&#39;</span> +</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                                           <span class="stringliteral">&#39; the DSORF entries should be not be considered to build the&#39;</span> +</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                                           <span class="stringliteral">&#39; PRO database needs to be a float (provided value: &#39;</span> + </div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                                           str( self.gen_len_diff_threshold ) + <span class="stringliteral">&#39; ).&#39;</span> )</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                <span class="keywordflow">if</span> ( ( self.gen_len_diff_threshold &lt; 0 ) </div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                     <span class="keywordflow">and</span> ( self.gen_len_diff_threshold != Constants.GEN_LEN_DIFF_THRESHOLD_IGNORE ) ):</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                    <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;MergeStrategy.parse_config(): The threshold to used as minimal&#39;</span> +</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                                               <span class="stringliteral">&#39; value for the absolute difference in genomic lengths at which&#39;</span> +</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                                               <span class="stringliteral">&#39; the DSORF entries should be not be considered to build the&#39;</span> +</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                                               <span class="stringliteral">&#39; PRO database needs to be a positive float (provided value: &#39;</span> + </div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                                               str( self.gen_len_diff_threshold ) + <span class="stringliteral">&#39; ).&#39;</span> )</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            self.gen_len_diff_threshold = Constants.DEFAULT_MERGE_GEN_LEN_DIFF_THRESHOLD</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;            Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.parse_config(): As there was no value provided&#39;</span> +</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                                         <span class="stringliteral">&#39; for the threshold the absolute difference in genomic lengths&#39;</span> +</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                                         <span class="stringliteral">&#39; at which the DSORF entries should be not be considered to&#39;</span> +</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                                         <span class="stringliteral">&#39; build the PRO database in the config file, the default value&#39;</span> +</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                                         <span class="stringliteral">&#39; of &#39;</span> + str( Constants.DEFAULT_MERGE_GEN_LEN_DIFF_THRESHOLD ) + </div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                                         <span class="stringliteral">&#39; will be used.&#39;</span> )</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        </div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        </div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="comment"># Get the value of the threshold to use when computing </span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="comment"># the consensus sequence if it is provided</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <span class="keywordflow">if</span> config.has_option( Constants.CONFIG_SECTION_MERGE_PARAMETERS, Constants.CONFIG_SECTION_MERGE_PARAMETERS_ITEM_SQCE_CONSENSUS_AMBIG_THRESHOLD ):</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;            self.sqce_consensus_ambig_threshold = config.get( Constants.CONFIG_SECTION_MERGE_PARAMETERS, </div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                                                              Constants.CONFIG_SECTION_MERGE_PARAMETERS_ITEM_SQCE_CONSENSUS_AMBIG_THRESHOLD )</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                self.sqce_consensus_ambig_threshold = float( self.sqce_consensus_ambig_threshold )</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;            <span class="keywordflow">except</span>:</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;MergeStrategy.parse_config(): The threshold to use to compute&#39;</span> +</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                                           <span class="stringliteral">&#39; the sequence consensus needs to be a float (provided value: &#39;</span> + </div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                                           str( self.sqce_consensus_ambig_threshold ) + <span class="stringliteral">&#39; ).&#39;</span> )</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                <span class="keywordflow">if</span> ( ( self.sqce_consensus_ambig_threshold &lt; 0 ) </div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                     <span class="keywordflow">or</span> ( self.sqce_consensus_ambig_threshold &gt; 1 ) ):</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                    <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;MergeStrategy.parse_config(): The threshold to use to&#39;</span> +</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                                               <span class="stringliteral">&#39; compute the sequence consensus needs to be a float&#39;</span> +</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                                               <span class="stringliteral">&#39; between 0 and 1 (provided value: &#39;</span> + </div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                                               str( self.sqce_consensus_ambig_threshold ) + <span class="stringliteral">&#39; ).&#39;</span> )</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            self.sqce_consensus_ambig_threshold = Constants.DEFAULT_SQCE_CONSENSUS_AMBIG_THRESHOLD</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.parse_config(): As there was no value provided&#39;</span> +</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                                         <span class="stringliteral">&#39; for the threshold to use to compute the sequence consensus&#39;</span> +</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                                         <span class="stringliteral">&#39; in the config file, the default value of &#39;</span> + </div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                                         str( Constants.DEFAULT_SQCE_CONSENSUS_AMBIG_THRESHOLD ) + </div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                                         <span class="stringliteral">&#39; will be used.&#39;</span> )</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    </div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        <span class="comment"># Get the value for the maximal difference between the </span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <span class="comment"># max. and min. lengths of DSORFTranscriptAsso to make them belong </span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        <span class="comment"># to the same &quot;cluster&quot;</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        <span class="keywordflow">if</span> config.has_option( Constants.CONFIG_SECTION_MERGE_PARAMETERS, Constants.CONFIG_SECTION_MERGE_PARAMETERS_ITEM_MAX_LEN_DIFF_FOR_DSOTA_CLUSTERS ):</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            self.max_len_diff_dsota_clust = config.get( Constants.CONFIG_SECTION_MERGE_PARAMETERS, </div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                                                        Constants.CONFIG_SECTION_MERGE_PARAMETERS_ITEM_MAX_LEN_DIFF_FOR_DSOTA_CLUSTERS )</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                self.max_len_diff_dsota_clust = int( self.max_len_diff_dsota_clust )</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            <span class="keywordflow">except</span>:</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;MergeStrategy.parse_config(): The value for the maximal&#39;</span> +</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                                           <span class="stringliteral">&#39; difference between the max. and min. lengths of&#39;</span> +</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                                           <span class="stringliteral">&#39; DSORFTranscriptAsso to make them belong to the same &quot;cluster&quot;&#39;</span> +</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                                           <span class="stringliteral">&#39; needs to be an integer (provided value: &#39;</span> + </div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                                           str( self.max_len_diff_dsota_clust ) + <span class="stringliteral">&#39; ).&#39;</span> )</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                <span class="keywordflow">if</span> ( self.max_len_diff_dsota_clust &lt; 0 ):</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                    <span class="keywordflow">raise</span> DenCellORFException( <span class="stringliteral">&#39;MergeStrategy.parse_config(): The value for the maximal&#39;</span> +</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                                               <span class="stringliteral">&#39; difference between the max. and min. lengths of&#39;</span> +</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                                               <span class="stringliteral">&#39; DSORFTranscriptAsso to make them belong to the same &quot;cluster&quot;&#39;</span> +</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                                               <span class="stringliteral">&#39; needs to be a positive integer (provided value: &#39;</span> +  </div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                                               str( self.sqce_consensus_ambig_threshold ) + <span class="stringliteral">&#39; ).&#39;</span> )</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;            self.max_len_diff_dsota_clust = Constants.DEFAULT_MAX_LEN_DIFF_FOR_DSOTA_CLUSTERS</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            Logger.get_instance().debug( <span class="stringliteral">&#39;MergeStrategy.parse_config(): As there was no value for the&#39;</span> +</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                                         <span class="stringliteral">&#39; maximal difference between the max. and min. lengths of&#39;</span> +</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                                         <span class="stringliteral">&#39; DSORFTranscriptAsso to make them belong to the same &quot;cluster&quot;&#39;</span> +</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                                         <span class="stringliteral">&#39; in the config file, the default value of &#39;</span> + </div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                                         str( Constants.DEFAULT_MAX_LEN_DIFF_FOR_DSOTA_CLUSTERS ) + </div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                                        <span class="stringliteral">&#39; will be used.&#39;</span> )</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;            </div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            </div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    </div></div><!-- fragment -->
</div>
</div>
<a id="a89468c0136edff99d9ac22d5fb31a236"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a89468c0136edff99d9ac22d5fb31a236">&#9670;&nbsp;</a></span>save_list_of_obj()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">def fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.save_list_of_obj </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>objects_to_insert</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>filename</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<h2>save_list_of_obj </h2>
<p>This is a static method that allows to save in a file a list of objects expected to be added or that have been added to the PRO database.</p>
<p>NB: So far there is NOT any strategy that allows to use these files to retry the insertion of data into the PRO database if it failed. Nevertheless, if necessary it would be feasible to create a new strategy similar to the InsertionStrategy that uses the content of these file to retry the insertion into the PRO database; saving the computation time if the merging occurred successfully but an exception has been raised during the insertion into the database.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">objects_to_insert</td><td>List - The list of objects to insert in the database. </td></tr>
    <tr><td class="paramname">filename</td><td>String - The name of the filename where data are saved. </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;    <span class="keyword">def </span>save_list_of_obj( objects_to_insert, filename ):</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;        </div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;            FileHandlerUtil.save_obj_to_file( objects_to_save = objects_to_insert,</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;                                              filename = <span class="stringliteral">&#39;objects_from_&#39;</span> + filename,</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;                                              output_folder = Constants.MERGED_DATA_FOLDER )</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;            Logger.get_instance().error( <span class="stringliteral">&#39;MergeStrategy.batch_insert_to_PRO_db():&#39;</span> +</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;                                         <span class="stringliteral">&#39; An error occurred trying to save data from &#39;</span> + </div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;                                         process + <span class="stringliteral">&#39;: \n&#39;</span> + str( e ) +</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;                                         <span class="stringliteral">&#39;\n Error code: &#39;</span> + LogCodes.ERR_FILEHAND + <span class="stringliteral">&#39;.&#39;</span>,</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;                                         ex = <span class="keyword">False</span> )</div></div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="a71f015d744748095fd8c47d49b0bfcfa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a71f015d744748095fd8c47d49b0bfcfa">&#9670;&nbsp;</a></span>ATTRIBUTES_FOR_MERGING_SAME_DSORF</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">list fr.tagc.uorf.core.execution.MergeStrategy.MergeStrategy.ATTRIBUTES_FOR_MERGING_SAME_DSORF</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line">=  [ <span class="stringliteral">&#39;chromosome&#39;</span>, <span class="stringliteral">&#39;strand&#39;</span>, <span class="stringliteral">&#39;start_pos&#39;</span>, <span class="stringliteral">&#39;stop_pos&#39;</span>, <span class="stringliteral">&#39;spliced&#39;</span>, </div><div class="line">                                          <span class="stringliteral">&#39;spliced_parts_count&#39;</span>, <span class="stringliteral">&#39;splice_starts&#39;</span>, <span class="stringliteral">&#39;splice_ends&#39;</span> ]</div></div><!-- fragment --><h2>Class variables </h2>
<p>List of attributes to look at for merging the same DSORFs together </p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>/mnt/NAS7/Workspace/choteaus/tagc-uorf/project/01_ORF_datafreeze/06_src/fr/tagc/uorf/core/execution/MergeStrategy.py</li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
